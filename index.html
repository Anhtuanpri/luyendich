<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Coach: WRITING</title>
  <meta name="description" content="Luy·ªán d·ªãch VI‚ÜíEN, t·∫°o c√¢u theo band, ch·∫•m IELTS 4 ti√™u ch√≠." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <!-- CSS c·ªßa b·∫°n -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ==== UI GI·ªÆ NGUY√äN NH∆Ø B·∫†N D√ÅN (ƒë√£ ƒë√∫ng id/class) ==== -->
  <!-- m√¨nh gi·ªØ nguy√™n c·∫•u tr√∫c b·∫°n g·ª≠i, ch·ªâ b·ªè h·∫øt script inline c≈© ƒë·ªÉ tr√°nh ƒë√® callOpenAI -->
  <div class="container">
    <header>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnHamburger" class="hamburger" title="Menu">|||</button>
        <div>
          <h1>The Coach: WRITING</h1>
          <p class="lead">T·∫°o C√¢u Chu·∫©n Band - Ch·∫•m ƒê·ªß 4 Ti√™u Ch√≠</p>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" id="tabPractice">Luy·ªán t·∫≠p</button>
        <button class="tab" id="tabManual">T·∫°o th·ªß c√¥ng</button>
        <button class="tab" id="tabGenSent">T·∫°o C√¢u</button>
        <button class="tab" id="tabSpoken">T·∫°o VƒÉn N√≥i</button>
        <button class="tab" id="tabIELTSGen">T·∫°o VƒÉn IELTS</button>
        <button class="tab" id="tabWriting">Writing</button>
        <button class="tab" id="tabAsk">H·ªèi AI</button>
        <button class="tab" id="tabDict">T·ª´ ƒëi·ªÉn</button>
        <button class="tab" id="tabHistory">L·ªãch s·ª≠</button>
        <button class="tab" id="tabSettings">C√†i ƒë·∫∑t</button>
        <button id="toggleTheme" class="themeToggle" title="ƒê·ªïi giao di·ªán">üå§Ô∏è</button>
      </div>
    </header>

    <!-- ==== C√ÅC SECTION GI·ªÆ NGUY√äN NH∆Ø B·∫¢N C·ª¶A B·∫†N ==== -->
    <!-- Practice -->
    <section id="secPractice" class="grid two" style="margin-top:16px">
      <div class="card row">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="badge">B√†i luy·ªán d·ªãch VI ‚Üí EN</span><span id="counter" class="subtle">C√¢u 1/1</span>
        </div>
        <div class="progress"><div id="progbar" style="width:0%"></div></div>
        <div class="sectionTitle">H√£y D·ªãch</div>
        <div id="viBox" class="boxVI mono limit10">‚Äî</div>

        <div class="row">
          <div class="sectionTitle">Nh·∫≠p ƒê√°p √Ån ·ªû ƒê√¢y B·∫°n Nh√©ü•∞</div>
          <textarea id="answer" class="mono" placeholder="G√µ ti·∫øng Anh ·ªü ƒë√¢y..."></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnTranslateNow" class="btn">Xem m·∫´u c√¢u tham kh·∫£o</button>
            <button id="btnSuggest" class="btn">G·ª£i √Ω</button>
            <button id="btnGradeSimple" class="btn primary">Ch·∫•m nhanh 10‚Äì100</button>
            <button id="btnGradeIELTS" class="btn">Ch·∫•m IELTS (4 ti√™u ch√≠)</button>
          </div>
        </div>
        <div id="hint" class="subtle"></div>
      </div>

      <div class="row">
        <div class="card row">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="sectionTitle">G·ª£i √Ω t·ª´ AI Teacher</div>
            <label class="subtle"><input type="checkbox" id="toggleViGloss"> Hi·ªán d·ªãch VI</label>
          </div>
          <div class="kv"><b>Key idea</b><div id="gIdea" class="subtle">‚Äî</div></div>
          <div class="kv"><b>Vocabulary</b><div id="gVocab" class="subtle">‚Äî</div></div>
          <div class="kv"><b>Grammar</b><div id="gGrammar" class="subtle">‚Äî</div></div>
        </div>

        <div class="card row">
          <div class="sectionTitle">K·∫øt qu·∫£</div>
          <div id="gradeHeader" class="subtle">Ch∆∞a ch·∫•m.</div>
          <div id="gradeDiff" class="diff mono scrollBox"></div>
          <div id="gradeBreakdown" class="row"></div>
        </div>
      </div>
    </section>

    <!-- Manual -->
    <section id="secManual" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·∫°o c√¢u/ƒëo·∫°n ti·∫øng Vi·ªát th·ªß c√¥ng ‚Ä¢ Th√™m v√†o Luy·ªán t·∫≠p</div>
      <textarea id="manualVI" class="mono" placeholder="D√°n nhi·ªÅu d√≤ng, m·ªói d√≤ng 1 c√¢u. C√≥ th·ªÉ d√°n ƒëo·∫°n d√†i."></textarea>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btnUseManual" class="btn primary">Th√™m v√†o Luy·ªán t·∫≠p</button>
        <span id="manualHint" class="subtle"></span>
      </div>
    </section>

    <!-- Gen Sentences -->
    <section id="secGenSent" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·∫°o c√¢u ti·∫øng Vi·ªát theo band (A2/B1/B2/C1) + Ng·ªØ c·∫£nh</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <div class="grid" style="grid-template-columns:repeat(4,1fr);gap:8px">
            <label>Band
              <select id="gsBand" class="select">
                <option value="A2">A2</option>
                <option value="B1" selected>B1</option>
                <option value="B2">B2</option>
                <option value="C1">C1</option>
              </select>
            </label>
            <label>ƒê·ªô d√†i
              <select id="gsLen" class="select">
                <option value="short" selected>Ng·∫Øn (~8‚Äì15)</option>
                <option value="medium">V·ª´a (~12‚Äì20)</option>
              </select>
            </label>
            <label>S·ªë c√¢u
              <input id="gsCount" type="number" min="1" max="30" value="6" class="input" />
            </label>
            <label>Ch·ªß ƒë·ªÅ
              <input id="gsTopic" class="input" placeholder="gia ƒë√¨nh, c√¥ng vi·ªác, du l·ªãch..." />
            </label>
          </div>
          <label>Ng·ªØ c·∫£nh (tu·ª≥ ch·ªçn)
            <textarea id="gsContext" class="mono" placeholder="V√≠ d·ª•: h·ªôi tho·∫°i qu√°n c√† ph√™..."></textarea>
          </label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="btnGSGen" class="btn primary">T·∫°o c√¢u (VI)</button>
            <span id="gsHint" class="subtle"></span>
          </div>
        </div>
        <aside class="row">
          <div class="sectionTitle">K·∫øt qu·∫£</div>
          <div id="gsOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
          <div style="display:flex;gap:8px">
            <button id="btnGSUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- Spoken -->
    <section id="secSpoken" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·∫°o b√†i <b>vƒÉn n√≥i</b> (ti·∫øng Vi·ªát)</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
            <label>Ch·ªß ƒë·ªÅ<input id="spTopic" class="input" placeholder="ƒë·ªùi s·ªëng, h·ªçc t·∫≠p..." /></label>
            <label>ƒê·ªô d√†i
              <select id="spLen" class="select">
                <option value="short">~80‚Äì120</option>
                <option value="medium" selected>~150‚Äì200</option>
                <option value="long">~220‚Äì300</option>
              </select>
            </label>
          </div>
          <label>Ng·ªØ c·∫£nh (tu·ª≥ ch·ªçn)
            <textarea id="spContext" class="mono" placeholder="k·ªÉ chuy·ªán v·ªõi b·∫°n; tr√¨nh b√†y tr∆∞·ªõc l·ªõp..."></textarea>
          </label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button id="btnSpGen" class="btn primary">T·∫°o vƒÉn n√≥i (VI)</button>
            <button id="btnSpUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button>
            <button id="btnSpTransGrade" class="btn">D·ªãch & Ch·∫•m IELTS</button>
            <span id="spHint" class="subtle"></span>
          </div>
        </div>
        <aside class="row">
          <div class="sectionTitle">K·∫øt qu·∫£</div>
          <div id="spOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
        </aside>
      </div>
    </section>

    <!-- IELTS Gen -->
    <section id="secIELTSGen" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·∫°o b√†i <b>vƒÉn IELTS</b> (VI): Task 1 / Task 2</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <select id="genEssayType" class="select" style="max-width:220px">
              <option value="task2" selected>Task 2</option>
              <option value="task1">Task 1</option>
            </select>
            <select id="genEssayLen" class="select" style="max-width:220px">
              <option value="short">~140</option>
              <option value="medium" selected>~200‚Äì230</option>
              <option value="long">~260‚Äì300</option>
            </select>
            <button id="btnGenEssayVI" class="btn primary">T·∫°o b√†i vƒÉn IELTS (VI)</button>
            <button id="btnIELTSUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button>
            <button id="btnIELTSTransGrade" class="btn">D·ªãch & Ch·∫•m IELTS</button>
            <span id="ieltsGenHint" class="subtle"></span>
          </div>
        </div>
        <aside class="row">
          <div class="sectionTitle">K·∫øt qu·∫£</div>
          <div id="ieltsGenOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
        </aside>
      </div>
    </section>

    <!-- Writing -->
    <section id="secWriting" class="card row" style="display:none;margin-top:16px">
      <div class="badge">Writing Task ‚Ä¢ Ch·∫•m IELTS & D·ªãch VI ‚ûú EN</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <label>ƒê·ªÅ b√†i</label>
          <textarea id="wrPrompt" class="mono" placeholder="Nh·∫≠p ƒë·ªÅ vi·∫øt..."></textarea>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="btnGenPrompt" class="btn">T·∫°o ƒë·ªÅ b·∫±ng AI</button>
            <select id="wrType" class="select">
              <option value="task2" selected>Task 2</option>
              <option value="task1">Task 1</option>
            </select>
            <span id="wrPromptHint" class="subtle"></span>
          </div>
          <label style="margin-top:10px">B√†i vi·∫øt (EN) ‚Äî d√πng ƒë·ªÉ ch·∫•m</label>
          <textarea id="wrEssay" class="mono" placeholder="Vi·∫øt b√†i b·∫±ng ti·∫øng Anh..."></textarea>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <button id="btnGradeEssay" class="btn primary">Ch·∫•m IELTS (4 ti√™u ch√≠)</button>
            <span id="wrHint" class="subtle"></span>
          </div>
        </div>
        <aside class="row">
          <div class="sectionTitle">·∫¢nh bi·ªÉu ƒë·ªì (tu·ª≥ ch·ªçn)</div>
          <div id="chartBox" style="border:1px dashed var(--line);border-radius:12px;padding:10px;display:grid;place-items:center;cursor:pointer;min-height:150px;background:#fbfdff">
            <span class="subtle">Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh (png/jpg)</span>
            <img id="chartImg" alt="" style="max-width:100%;display:none;border-radius:8px">
          </div>
          <input id="chartPicker" type="file" accept="image/*" style="display:none">
        </aside>
      </div>

      <div class="card row" style="margin-top:10px">
        <div class="sectionTitle">D·ªãch b√†i ti·∫øng Vi·ªát ‚ûú English (gi·ªØ phong c√°ch IELTS)</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="trTaskType" class="select" style="max-width:220px">
            <option value="task2" selected>Task 2</option>
            <option value="task1">Task 1</option>
          </select>
          <button id="btnTranslateTask" class="btn">D·ªãch b√†i VI ‚ûú EN</button>
          <button id="btnGradeTranslated" class="btn">Ch·∫•m k·∫øt qu·∫£ d·ªãch</button>
          <span id="trTaskHint" class="subtle"></span>
        </div>
        <textarea id="trTaskInput" class="mono" placeholder="D√°n b√†i ti·∫øng Vi·ªát (Task 1/2) v√†o ƒë√¢y..."></textarea>
        <div class="sectionTitle">K·∫øt qu·∫£ d·ªãch (EN)</div>
        <div id="trTaskOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
      </div>

      <div class="card row" id="wrResult" style="display:none">
        <div class="sectionTitle">K·∫øt qu·∫£ IELTS</div>
        <div id="wrHead" class="subtle">‚Äî</div>
        <div id="wrDiff" class="diff mono scrollBox"></div>
        <div id="wrBreakdown" class="row"></div>
      </div>
    </section>

    <!-- Ask AI -->
    <section id="secAsk" class="card row" style="display:none;margin-top:16px">
      <div class="badge">H·ªèi AI (gi·∫£i th√≠ch ng·ªØ ph√°p, s·ª≠a c√¢u,...)</div>
      <div class="chat" id="chatBox"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input id="askInput" class="input" placeholder="V√≠ d·ª•: present perfect vs past simple..." />
        <button id="btnAsk" class="btn primary">G·ª≠i</button>
        <span id="askHint" class="subtle"></span>
      </div>
    </section>

    <!-- Dict -->
    <section id="secDict" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·ª´ ƒëi·ªÉn ng·ªØ c·∫£nh</div>
      <div class="grid" style="grid-template-columns:1.1fr .9fr">
        <div class="row">
          <label>Tra t·ª´/c·ª•m t·ª´<input id="q" class="input" placeholder="take off, anxiety, run into..." /></label>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnLookup" class="btn primary">Tra</button>
            <button id="btnLookupFromVI" class="btn">G·ª£i √Ω d·ªãch c√¢u hi·ªán t·∫°i</button>
            <span id="dictHint" class="subtle"></span>
          </div>
          <div id="dictOut" class="row"></div>
        </div>
        <aside class="row">
          <div class="sectionTitle">L·ªãch s·ª≠ t·ª´ ƒëi·ªÉn</div>
          <div id="dictHistory" class="subtle">Ch∆∞a c√≥.</div>
        </aside>
      </div>
    </section>

    <!-- History -->
    <section id="secHistory" class="card row" style="display:none;margin-top:16px">
      <div class="badge">L·ªãch s·ª≠ l√†m b√†i</div>
      <div class="row" style="grid-template-columns:repeat(4,1fr);gap:10px">
        <div class="stat"><span>T·ªïng l∆∞·ª£t</span><b id="hisTotal">0</b></div>
        <div class="stat"><span>ƒêi·ªÉm TB</span><b id="hisAvg">0</b></div>
        <div class="stat"><span>ƒê√∫ng (Simple ‚â•90)</span><b id="hisCorrect">0</b></div>
        <div class="stat"><span>T·ªâ l·ªá ƒë√∫ng</span><b id="hisRate">0%</b></div>
      </div>
      <table class="table" id="hisTable">
        <thead><tr><th>Th·ªùi gian</th><th>Lo·∫°i</th><th>Input</th><th>ƒêi·ªÉm/Band</th><th>K·∫øt qu·∫£</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Settings -->
    <section id="secSettings" class="card row" style="display:none;margin-top:16px">
      <div class="badge">C√†i ƒë·∫∑t API</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <label>OpenAI API Key
            <input id="apiKey" class="input" type="password" placeholder="sk-..." />
          </label>
          <div class="subtle">ƒê·ªÉ tr·ªëng ƒë·ªÉ d√πng Worker proxy.</div>
        </div>
        <div class="row">
          <label>Model
            <select id="model" class="select">
              <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
              <option value="gpt-4o">gpt-4o</option>
              <option value="gpt-4.1-mini">gpt-4.1-mini</option>
            </select>
          </label>
          <label style="margin-top:6px">Endpoint
            <input id="endpoint" class="input" value="https://api.openai.com/v1/chat/completions" />
          </label>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnSave" class="btn primary">L∆∞u</button><span id="saveMsg" class="subtle"></span>
      </div>
    </section>
  </div>

  <!-- Footer -->
  <div id="footerNav" class="footerNav">
    <div class="wrapNav"><span class="subtle">Ph√≠m t·∫Øt: ‚Üê / ‚Üí</span>
      <div style="display:flex;gap:8px">
        <button id="btnPrev" class="btn">C√¢u tr∆∞·ªõc</button>
        <button id="btnNext" class="btn primary">C√¢u ti·∫øp theo</button>
      </div>
    </div>
  </div>

  <!-- Drawer + backdrop -->
  <div id="drawer" class="drawer" aria-label="Menu">‚Ä¶</div>
  <div id="backdrop" class="backdrop"></div>

  <!-- JS duy nh·∫•t -->
  <script defer src="app.js"></script>
<!-- Popup h∆∞·ªõng d·∫´n h·ªçc -->
<div id="eduPopup" role="dialog" aria-modal="true" aria-labelledby="epTitle" aria-describedby="epMsg"
     style="position:fixed;inset:0;z-index:9999;display:none;place-items:center;
            background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(2px)">
  <div style="background:#fff;max-width:480px;width:92%;border-radius:12px;
              padding:20px;box-shadow:0 12px 32px rgba(0,0,0,.2);position:relative">
    <button id="epClose" type="button" aria-label="ƒê√≥ng"
            style="position:absolute;top:10px;right:12px;font-size:20px;
                   background:none;border:0;cursor:pointer">√ó</button>
    <h3 id="epTitle" style="margin:0 0 12px;font-size:18px">H∆∞·ªõng d·∫´n h·ªçc hi·ªáu qu·∫£</h3>
    <div id="epMsg" style="white-space:pre-wrap;line-height:1.6"></div>
    <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
      <button id="epNext" class="btn">ƒê·ªçc ti·∫øp ‚Üí</button>
      <button id="epNever" class="btn">ƒê√≥ng vƒ©nh vi·ªÖn</button>
    </div>
  </div>
</div>

<script>
(function(){
  const steps = [
    "üìå **L·ªúI KHUY√äN**\nH·ªçc theo v√≤ng nh·ªè: (1) ƒë·ªçc c√¢u **VI** ‚Üí (2) t·ª± vi·∫øt **EN** ng·∫Øn g·ªçn ‚Üí (3) so v·ªõi g·ª£i √Ω & s·ª≠a l·ªói ‚Üí (4) ghi ch√∫ l·∫°i 1‚Äì2 m·∫´u c√¢u b·∫°n th√≠ch. **L·∫∑p l·∫°i nhi·ªÅu v√≤ng** s·∫Ω nh·ªõ l√¢u h∆°n.",
    "üí° **C√ÅCH D√ôNG NHANH**\n‚Ä¢ **T·∫°o c√¢u theo level** ƒë·ªÉ luy·ªán d·ªãch c√≥ ng·ªØ c·∫£nh.\n‚Ä¢ **Vi·∫øt EN tr∆∞·ªõc** r·ªìi b·∫•m **‚ÄòCh·∫•m nhanh‚Äô** ƒë·ªÉ th·∫•y ch·ªânh s·ª≠a t·ª´ng ch·ªó.\n‚Ä¢ Mu·ªën chi ti·∫øt h∆°n: d√πng **‚ÄòCh·∫•m IELTS (4 ti√™u ch√≠)‚Äô**.",
    "‚úÖ **L·ª¢I √çCH**\n‚Ä¢ **Th·∫•y ngay l·ªói** ng·ªØ ph√°p & c√°ch di·ªÖn ƒë·∫°t t·ª± nhi√™n.\n‚Ä¢ **M·ªü r·ªông v·ªën t·ª´** theo ch·ªß ƒë·ªÅ, bi·∫øt m·∫´u c√¢u d√πng th·∫≠t.\n‚Ä¢ **T·∫°o th√≥i quen t·ª± s·ª≠a** ‚Äì tƒÉng band b·ªÅn v·ªØng.",
    "‚ö†Ô∏è **T√ÅC H·∫†I TH∆Ø·ªúNG G·∫∂P**\n**D·ªãch m√°y 100%** ‚Üí th·ª• ƒë·ªông, nh·ªõ k√©m.\nüõ†Ô∏è **KH·∫ÆC PH·ª§C**: Lu√¥n vi·∫øt b·∫£n nh√°p c·ªßa b·∫°n **tr∆∞·ªõc** r·ªìi m·ªõi b·∫•m ch·∫•m/s·ª≠a. Sau ƒë√≥, ch√©p l·∫°i 1‚Äì2 c√¢u m·∫´u b·∫°n th√≠ch b·∫±ng t·ª´ c·ªßa ch√≠nh b·∫°n.",
    "‚ö†Ô∏è **D·ªäCH T·ª™NG T·ª™**\nB√°m s√°t ti·∫øng Vi·ªát qu√° khi·∫øn c√¢u EN g∆∞·ª£ng.\nüõ†Ô∏è **KH·∫ÆC PH·ª§C**: Nghƒ© **√Ω ch√≠nh b·∫±ng EN** (ch·ªß ng·ªØ‚Äìƒë·ªông t·ª´‚Äìb·ªï ng·ªØ), ∆∞u ti√™n c√¢u **ng·∫Øn, r√µ**. D√πng li√™n t·ª´ ƒë∆°n gi·∫£n (**and, but, because**) tr∆∞·ªõc ‚Äì r·ªìi n√¢ng c·∫•p d·∫ßn.",
    "üöÄ **M·∫∏O N√ÇNG C·∫§P NHANH**\n‚Ä¢ Vi·∫øt l·∫°i 1 c√¢u theo **2‚Äì3 th√¨ kh√°c nhau**.\n‚Ä¢ Th·ª≠ chuy·ªÉn **ch·ªß ƒë·ªông ‚Üî b·ªã ƒë·ªông**.\n‚Ä¢ Ghi ch√©p **collocation/phrases** + 1 v√≠ d·ª• ri√™ng.\n‚Ä¢ **5‚Äì10 ph√∫t/ng√†y nh∆∞ng ƒë·ªÅu ƒë·∫∑n > 1 gi·ªù/tu·∫ßn**."
  ];

  const popup = document.getElementById("eduPopup");
  const msg = document.getElementById("epMsg");
  const nextBtn = document.getElementById("epNext");
  const closeBtn = document.getElementById("epClose");
  const neverBtn = document.getElementById("epNever");
  let idx = 0;

  function formatBold(txt){
    return txt.replace(/\*\*(.+?)\*\*/g,"<b>$1</b>");
  }

  function showStep(i){
    msg.innerHTML = formatBold(steps[i]);
    nextBtn.style.display = (i < steps.length - 1) ? "inline-block" : "none";
  }

  function hidePopup(permanent){
    popup.style.display = "none";
    if(permanent){
      localStorage.setItem("eduPopupClosed","1");
    }
    document.body.style.overflow = "";
  }

  function showPopup(){
    if(localStorage.getItem("eduPopupClosed")) return;
    idx = 0;
    showStep(idx);
    popup.style.display = "grid";
    document.body.style.overflow = "hidden";
  }

  nextBtn.onclick = ()=>{ if(idx < steps.length-1){ idx++; showStep(idx);} };
  closeBtn.onclick = ()=> hidePopup(false);
  neverBtn.onclick = ()=> hidePopup(true);
  popup.addEventListener("click",e=>{ if(e.target===popup) hidePopup(false); });
  document.addEventListener("keydown",e=>{ if(e.key==="Escape") hidePopup(false); });

  window.addEventListener("load", showPopup);
})();
</script>
  <!-- ========= CHAT BOX HO√ÄN CH·ªàNH ========= -->
<div id="chat-widget" style="position:fixed;z-index:9999;display:none;">
  <button id="chat-toggle"
    style="background:#0a7cff;color:#fff;border:none;padding:10px 14px;border-radius:999px;
           cursor:pointer;font-family:sans-serif;box-shadow:0 8px 30px rgba(0,0,0,.25);">
    üí¨ H·ªó tr·ª£
  </button>

  <div id="chat-box" style="display:none;position:absolute;top:42px;right:0;width:340px;height:460px;
       background:#fff;border:1px solid #ccc;border-radius:14px;box-shadow:0 16px 50px rgba(0,0,0,.35);overflow:hidden;">
    <div id="chat-header" style="background:#0a7cff;color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;font-weight:bold;">
      <span>Chat H·ªó Tr·ª£</span>
      <div>
        <button id="chat-clear" style="background:transparent;color:#fff;border:none;cursor:pointer;"></button>
        <button id="chat-close" style="background:transparent;color:#fff;border:none;cursor:pointer;">‚úñ</button>
      </div>
    </div>

    <div id="chat-messages" style="height:calc(100% - 112px);padding:12px;overflow:auto;background:#f6f8fa;"></div>

    <div style="position:absolute;left:0;right:0;bottom:0;display:flex;gap:6px;padding:8px;border-top:1px solid #ddd;background:#fff;">
      <input id="chat-file" type="file" accept="image/*" hidden>
      <button id="img-btn" style="border:1px solid #ccc;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;">üì∑</button>
      <input id="chat-text" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..."
             style="flex:1;border:1px solid #ccc;border-radius:8px;padding:8px 10px;">
      <button id="send-btn" style="background:#0a7cff;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;">G·ª≠i</button>
    </div>
  </div>
</div>

<style>
  .msg-row{display:flex;gap:8px;margin:10px 0;align-items:flex-end;}
  .msg-row.you{justify-content:flex-start;}
  .msg-row.me{justify-content:flex-end;}
  .msg-bubble{position:relative;max-width:75%;padding:10px 12px;border-radius:14px;
              box-shadow:0 2px 8px rgba(0,0,0,.08);text-align:left;}
  .msg-row.me .msg-bubble{background:#0a7cff;color:#fff;border-bottom-right-radius:6px;margin-right:6px;}
  .msg-row.you .msg-bubble{background:#fff;color:#111;border:1px solid #ddd;border-bottom-left-radius:6px;margin-left:6px;}
  .msg-img{max-width:100%;border-radius:10px;display:block}
  .react-bar{display:flex;align-items:center;gap:8px;margin-top:6px;}
  .react-summary{font-size:12px;opacity:.85}
  .react-btn{border:none;background:transparent;cursor:pointer;font-size:14px;padding:3px 6px;border-radius:8px}
  .react-btn:hover{background:#f1f5ff}
  /* Picker n·ªïi to√†n c·ª•c */
  #tt-picker{position:fixed;display:none;z-index:2147483647;
             background:#fff;border:1px solid #ccc;border-radius:10px;
             box-shadow:0 10px 30px rgba(0,0,0,.25);padding:6px;}
  #tt-picker button{border:none;background:transparent;cursor:pointer;font-size:18px;padding:6px 8px;border-radius:8px;}
  #tt-picker button:hover{background:#f1f5ff}
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, runTransaction, get, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgTSTsGQaeGT9eaQCoCF6m58MBsdbHz-0",
    authDomain: "phan1-f7af4.firebaseapp.com",
    databaseURL: "https://phan1-f7af4-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "phan1-f7af4",
    storageBucket: "phan1-f7af4.appspot.com",
    messagingSenderId: "673326593732",
    appId: "1:673326593732:web:c7dd17ff2036264d25bb91",
    measurementId: "G-6WY24EN28R"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const MESSAGES   = ref(db, "messages");
  const SEVEN_DAYS = 7*24*60*60*1000;

  const widget=document.getElementById('chat-widget'),
        toggle=document.getElementById('chat-toggle'),
        box=document.getElementById('chat-box'),
        close=document.getElementById('chat-close'),
        clearBtn=document.getElementById('chat-clear'),
        msgs=document.getElementById('chat-messages'),
        input=document.getElementById('chat-text'),
        send=document.getElementById('send-btn'),
        imgBtn=document.getElementById('img-btn'),
        file=document.getElementById('chat-file');

  // b√°m ti√™u ƒë·ªÅ
  const title=document.querySelector('h1')||document.querySelector('.page-title')||document.querySelector('[data-title]');
  function place(){
    if(!title){ widget.style.display='block'; widget.style.bottom='20px'; widget.style.right='20px'; return; }
    widget.style.display='block';
    const r=title.getBoundingClientRect(), sx=window.scrollX||0, sy=window.scrollY||0;
    widget.style.left=(r.right+sx+8)+'px'; widget.style.top=(r.top+sy-4)+'px';
    widget.style.right=''; widget.style.bottom='';
  }
  place(); window.addEventListener('scroll',place,{passive:true}); window.addEventListener('resize',place);
  if('ResizeObserver' in window){ new ResizeObserver(place).observe(title||document.body); }

  // M·ªü/ƒë√≥ng
  toggle.onclick=()=>{ box.style.display = box.style.display==='block' ? 'none' : 'block'; };
  close.onclick=()=>{ box.style.display='none'; };
  clearBtn.onclick=async()=>{ if(confirm('Xo√° t·∫•t c·∫£?')){ await remove(MESSAGES); msgs.innerHTML=''; } };

  // picker to√†n c·ª•c
  const picker=document.createElement('div');
  picker.id='tt-picker';
  picker.innerHTML=`<button data-key="like">‚ù§Ô∏è</button><button data-key="haha">üòÑ</button><button data-key="angry">üò°</button>`;
  document.body.appendChild(picker);
  let pickerForMsgId=null;

  // helpers
  const esc = s => (s||'').replace(/</g,'&lt;').replace(/\n/g,'<br>');
  function updateSummary(el, r){ const p=[]; if(r?.like) p.push('‚ù§Ô∏è '+r.like); if(r?.haha) p.push('üòÑ '+r.haha); if(r?.angry) p.push('üò° '+r.angry); el.textContent=p.join('  '); }

  function makeRow(key, d){
    const row=document.createElement('div'); row.className='msg-row '+(d.type==='user'?'me':'you'); row.dataset.id=key;
    const bubble=document.createElement('div'); bubble.className='msg-bubble';
    if(d.img){ const im=document.createElement('img'); im.src=d.img; im.className='msg-img'; bubble.appendChild(im); }
    else{ bubble.innerHTML=esc(d.text); }

    const bar=document.createElement('div'); bar.className='react-bar';
    const pickBtn=document.createElement('button'); pickBtn.className='react-btn'; pickBtn.textContent='üôÇ';
    const sum=document.createElement('div'); sum.className='react-summary'; updateSummary(sum,d.reactions||{});
    pickBtn.onclick=(ev)=>{ev.stopPropagation(); pickerForMsgId=key; const r=pickBtn.getBoundingClientRect();
      picker.style.left=(r.right-picker.offsetWidth)+'px'; picker.style.top=(r.bottom+6)+'px'; picker.style.display='block';};
    bar.appendChild(pickBtn); bar.appendChild(sum);
    bubble.appendChild(bar); row.appendChild(bubble);
    return row;
  }

  document.addEventListener('click',()=>{ picker.style.display='none'; });
  picker.addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b||!pickerForMsgId) return;
    const key=b.dataset.key;
    runTransaction(ref(db,`messages/${pickerForMsgId}/reactions/${key}`),c=>(typeof c==='number'?c:0)+1);
    picker.style.display='none';
  });

  // g·ª≠i
  send.onclick=()=>{ if(input.value.trim()){ push(MESSAGES,{text:input.value.trim(),img:null,type:'user',time:Date.now(),reactions:{}}); input.value=''; } };
  input.onkeydown=e=>{ if(e.key==='Enter') send.onclick(); };
  imgBtn.onclick=()=>file.click();
  file.onchange=()=>{ const f=file.files[0]; if(f){ const rd=new FileReader(); rd.onload=e=>{ push(MESSAGES,{img:e.target.result,text:null,type:'user',time:Date.now(),reactions:{}}); }; rd.readAsDataURL(f); } };

  // cleanup >7 ng√†y
  async function cleanup(){ const s=await get(MESSAGES),now=Date.now(); s.forEach(ch=>{if(ch.val().time&&now-ch.val().time>SEVEN_DAYS) remove(ch.ref);}); }
  cleanup();

  // realtime
  onChildAdded(MESSAGES,snap=>{ const v=snap.val(); if(v?.time&&Date.now()-v.time>SEVEN_DAYS){remove(snap.ref);return;}
    msgs.appendChild(makeRow(snap.key,v)); msgs.scrollTop=msgs.scrollHeight; });
  onChildChanged(MESSAGES,snap=>{ const row=msgs.querySelector(`[data-id="${snap.key}"]`); if(!row) return;
    const v=snap.val(); const sum=row.querySelector('.react-summary'); updateSummary(sum,v.reactions||{}); });
</script>
<!-- ========= /CHAT ========= -->
</body>
</html>
