<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Coach: WRITING</title>
  <meta name="description" content="Luy·ªán d·ªãch VI‚ÜíEN, t·∫°o c√¢u theo band, ch·∫•m IELTS 4 ti√™u ch√≠." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <!-- CSS c·ªßa b·∫°n -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ==== UI GI·ªÆ NGUY√äN NH∆Ø B·∫†N D√ÅN (ƒë√£ ƒë√∫ng id/class) ==== -->
  <!-- m√¨nh gi·ªØ nguy√™n c·∫•u tr√∫c b·∫°n g·ª≠i, ch·ªâ b·ªè h·∫øt script inline c≈© ƒë·ªÉ tr√°nh ƒë√® callOpenAI -->
  <div class="container">
    <header>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnHamburger" class="hamburger" title="Menu">|||</button>
        <div>
          <h1>The Coach: WRITING</h1>
          <p class="lead">T·∫°o C√¢u Chu·∫©n Band - Ch·∫•m ƒê·ªß 4 Ti√™u Ch√≠</p>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" id="tabPractice">Luy·ªán t·∫≠p</button>
        <button class="tab" id="tabManual">T·∫°o th·ªß c√¥ng</button>
        <button class="tab" id="tabGenSent">T·∫°o C√¢u</button>
        <button class="tab" id="tabSpoken">T·∫°o VƒÉn N√≥i</button>
        <button class="tab" id="tabIELTSGen">T·∫°o VƒÉn IELTS</button>
        <button class="tab" id="tabWriting">Writing</button>
        <button class="tab" id="tabAsk">H·ªèi AI</button>
        <button class="tab" id="tabDict">T·ª´ ƒëi·ªÉn</button>
        <button class="tab" id="tabHistory">L·ªãch s·ª≠</button>
        <button class="tab" id="tabSettings">C√†i ƒë·∫∑t</button>
        <button id="toggleTheme" class="themeToggle" title="ƒê·ªïi giao di·ªán">üå§Ô∏è</button>
      </div>
    </header>

    <!-- ==== C√ÅC SECTION GI·ªÆ NGUY√äN NH∆Ø B·∫¢N C·ª¶A B·∫†N ==== -->
    <!-- Practice -->
    <section id="secPractice" class="grid two" style="margin-top:16px">
      <div class="card row">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="badge">B√†i luy·ªán d·ªãch VI ‚Üí EN</span><span id="counter" class="subtle">C√¢u 1/1</span>
        </div>
        <div class="progress"><div id="progbar" style="width:0%"></div></div>
        <div class="sectionTitle">H√£y D·ªãch</div>
        <div id="viBox" class="boxVI mono limit10">‚Äî</div>

        <div class="row">
          <div class="sectionTitle">Nh·∫≠p ƒê√°p √Ån ·ªû ƒê√¢y B·∫°n Nh√©ü•∞</div>
          <textarea id="answer" class="mono" placeholder="G√µ ti·∫øng Anh ·ªü ƒë√¢y..."></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnTranslateNow" class="btn">Xem m·∫´u c√¢u tham kh·∫£o</button>
            <button id="btnSuggest" class="btn">G·ª£i √Ω</button>
            <button id="btnGradeSimple" class="btn primary">Ch·∫•m nhanh 10‚Äì100</button>
            <button id="btnGradeIELTS" class="btn">Ch·∫•m IELTS (4 ti√™u ch√≠)</button>
          </div>
        </div>
        <div id="hint" class="subtle"></div>
      </div>

      <div class="row">
        <div class="card row">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="sectionTitle">G·ª£i √Ω t·ª´ AI Teacher</div>
            <label class="subtle"><input type="checkbox" id="toggleViGloss"> Hi·ªán d·ªãch VI</label>
          </div>
          <div class="kv"><b>Key idea</b><div id="gIdea" class="subtle">‚Äî</div></div>
          <div class="kv"><b>Vocabulary</b><div id="gVocab" class="subtle">‚Äî</div></div>
          <div class="kv"><b>Grammar</b><div id="gGrammar" class="subtle">‚Äî</div></div>
        </div>

        <div class="card row">
          <div class="sectionTitle">K·∫øt qu·∫£</div>
          <div id="gradeHeader" class="subtle">Ch∆∞a ch·∫•m.</div>
          <div id="gradeDiff" class="diff mono scrollBox"></div>
          <div id="gradeBreakdown" class="row"></div>
        </div>
      </div>
    </section>

    <!-- Manual -->
    <section id="secManual" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·∫°o c√¢u/ƒëo·∫°n ti·∫øng Vi·ªát th·ªß c√¥ng ‚Ä¢ Th√™m v√†o Luy·ªán t·∫≠p</div>
      <textarea id="manualVI" class="mono" placeholder="D√°n nhi·ªÅu d√≤ng, m·ªói d√≤ng 1 c√¢u. C√≥ th·ªÉ d√°n ƒëo·∫°n d√†i."></textarea>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btnUseManual" class="btn primary">Th√™m v√†o Luy·ªán t·∫≠p</button>
        <span id="manualHint" class="subtle"></span>
      </div>
    </section>

    <!-- Gen Sentences -->
    <section id="secGenSent" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·∫°o c√¢u ti·∫øng Vi·ªát theo band (A2/B1/B2/C1) + Ng·ªØ c·∫£nh</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <div class="grid" style="grid-template-columns:repeat(4,1fr);gap:8px">
            <label>Band
              <select id="gsBand" class="select">
                <option value="A2">A2</option>
                <option value="B1" selected>B1</option>
                <option value="B2">B2</option>
                <option value="C1">C1</option>
              </select>
            </label>
            <label>ƒê·ªô d√†i
              <select id="gsLen" class="select">
                <option value="short" selected>Ng·∫Øn (~8‚Äì15)</option>
                <option value="medium">V·ª´a (~12‚Äì20)</option>
              </select>
            </label>
            <label>S·ªë c√¢u
              <input id="gsCount" type="number" min="1" max="30" value="6" class="input" />
            </label>
            <label>Ch·ªß ƒë·ªÅ
              <input id="gsTopic" class="input" placeholder="gia ƒë√¨nh, c√¥ng vi·ªác, du l·ªãch..." />
            </label>
          </div>
          <label>Ng·ªØ c·∫£nh (tu·ª≥ ch·ªçn)
            <textarea id="gsContext" class="mono" placeholder="V√≠ d·ª•: h·ªôi tho·∫°i qu√°n c√† ph√™..."></textarea>
          </label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="btnGSGen" class="btn primary">T·∫°o c√¢u (VI)</button>
            <span id="gsHint" class="subtle"></span>
          </div>
        </div>
        <aside class="row">
          <div class="sectionTitle">K·∫øt qu·∫£</div>
          <div id="gsOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
          <div style="display:flex;gap:8px">
            <button id="btnGSUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- Spoken -->
    <section id="secSpoken" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·∫°o b√†i <b>vƒÉn n√≥i</b> (ti·∫øng Vi·ªát)</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
            <label>Ch·ªß ƒë·ªÅ<input id="spTopic" class="input" placeholder="ƒë·ªùi s·ªëng, h·ªçc t·∫≠p..." /></label>
            <label>ƒê·ªô d√†i
              <select id="spLen" class="select">
                <option value="short">~80‚Äì120</option>
                <option value="medium" selected>~150‚Äì200</option>
                <option value="long">~220‚Äì300</option>
              </select>
            </label>
          </div>
          <label>Ng·ªØ c·∫£nh (tu·ª≥ ch·ªçn)
            <textarea id="spContext" class="mono" placeholder="k·ªÉ chuy·ªán v·ªõi b·∫°n; tr√¨nh b√†y tr∆∞·ªõc l·ªõp..."></textarea>
          </label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button id="btnSpGen" class="btn primary">T·∫°o vƒÉn n√≥i (VI)</button>
            <button id="btnSpUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button>
            <button id="btnSpTransGrade" class="btn">D·ªãch & Ch·∫•m IELTS</button>
            <span id="spHint" class="subtle"></span>
          </div>
        </div>
        <aside class="row">
          <div class="sectionTitle">K·∫øt qu·∫£</div>
          <div id="spOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
        </aside>
      </div>
    </section>

    <!-- IELTS Gen -->
    <section id="secIELTSGen" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·∫°o b√†i <b>vƒÉn IELTS</b> (VI): Task 1 / Task 2</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <select id="genEssayType" class="select" style="max-width:220px">
              <option value="task2" selected>Task 2</option>
              <option value="task1">Task 1</option>
            </select>
            <select id="genEssayLen" class="select" style="max-width:220px">
              <option value="short">~140</option>
              <option value="medium" selected>~200‚Äì230</option>
              <option value="long">~260‚Äì300</option>
            </select>
            <button id="btnGenEssayVI" class="btn primary">T·∫°o b√†i vƒÉn IELTS (VI)</button>
            <button id="btnIELTSUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button>
            <button id="btnIELTSTransGrade" class="btn">D·ªãch & Ch·∫•m IELTS</button>
            <span id="ieltsGenHint" class="subtle"></span>
          </div>
        </div>
        <aside class="row">
          <div class="sectionTitle">K·∫øt qu·∫£</div>
          <div id="ieltsGenOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
        </aside>
      </div>
    </section>

    <!-- Writing -->
    <section id="secWriting" class="card row" style="display:none;margin-top:16px">
      <div class="badge">Writing Task ‚Ä¢ Ch·∫•m IELTS & D·ªãch VI ‚ûú EN</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <label>ƒê·ªÅ b√†i</label>
          <textarea id="wrPrompt" class="mono" placeholder="Nh·∫≠p ƒë·ªÅ vi·∫øt..."></textarea>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="btnGenPrompt" class="btn">T·∫°o ƒë·ªÅ b·∫±ng AI</button>
            <select id="wrType" class="select">
              <option value="task2" selected>Task 2</option>
              <option value="task1">Task 1</option>
            </select>
            <span id="wrPromptHint" class="subtle"></span>
          </div>
          <label style="margin-top:10px">B√†i vi·∫øt (EN) ‚Äî d√πng ƒë·ªÉ ch·∫•m</label>
          <textarea id="wrEssay" class="mono" placeholder="Vi·∫øt b√†i b·∫±ng ti·∫øng Anh..."></textarea>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <button id="btnGradeEssay" class="btn primary">Ch·∫•m IELTS (4 ti√™u ch√≠)</button>
            <span id="wrHint" class="subtle"></span>
          </div>
        </div>
        <aside class="row">
          <div class="sectionTitle">·∫¢nh bi·ªÉu ƒë·ªì (tu·ª≥ ch·ªçn)</div>
          <div id="chartBox" style="border:1px dashed var(--line);border-radius:12px;padding:10px;display:grid;place-items:center;cursor:pointer;min-height:150px;background:#fbfdff">
            <span class="subtle">Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh (png/jpg)</span>
            <img id="chartImg" alt="" style="max-width:100%;display:none;border-radius:8px">
          </div>
          <input id="chartPicker" type="file" accept="image/*" style="display:none">
        </aside>
      </div>

      <div class="card row" style="margin-top:10px">
        <div class="sectionTitle">D·ªãch b√†i ti·∫øng Vi·ªát ‚ûú English (gi·ªØ phong c√°ch IELTS)</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="trTaskType" class="select" style="max-width:220px">
            <option value="task2" selected>Task 2</option>
            <option value="task1">Task 1</option>
          </select>
          <button id="btnTranslateTask" class="btn">D·ªãch b√†i VI ‚ûú EN</button>
          <button id="btnGradeTranslated" class="btn">Ch·∫•m k·∫øt qu·∫£ d·ªãch</button>
          <span id="trTaskHint" class="subtle"></span>
        </div>
        <textarea id="trTaskInput" class="mono" placeholder="D√°n b√†i ti·∫øng Vi·ªát (Task 1/2) v√†o ƒë√¢y..."></textarea>
        <div class="sectionTitle">K·∫øt qu·∫£ d·ªãch (EN)</div>
        <div id="trTaskOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
      </div>

      <div class="card row" id="wrResult" style="display:none">
        <div class="sectionTitle">K·∫øt qu·∫£ IELTS</div>
        <div id="wrHead" class="subtle">‚Äî</div>
        <div id="wrDiff" class="diff mono scrollBox"></div>
        <div id="wrBreakdown" class="row"></div>
      </div>
    </section>

    <!-- Ask AI -->
    <section id="secAsk" class="card row" style="display:none;margin-top:16px">
      <div class="badge">H·ªèi AI (gi·∫£i th√≠ch ng·ªØ ph√°p, s·ª≠a c√¢u,...)</div>
      <div class="chat" id="chatBox"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input id="askInput" class="input" placeholder="V√≠ d·ª•: present perfect vs past simple..." />
        <button id="btnAsk" class="btn primary">G·ª≠i</button>
        <span id="askHint" class="subtle"></span>
      </div>
    </section>

    <!-- Dict -->
    <section id="secDict" class="card row" style="display:none;margin-top:16px">
      <div class="badge">T·ª´ ƒëi·ªÉn ng·ªØ c·∫£nh</div>
      <div class="grid" style="grid-template-columns:1.1fr .9fr">
        <div class="row">
          <label>Tra t·ª´/c·ª•m t·ª´<input id="q" class="input" placeholder="take off, anxiety, run into..." /></label>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnLookup" class="btn primary">Tra</button>
            <button id="btnLookupFromVI" class="btn">G·ª£i √Ω d·ªãch c√¢u hi·ªán t·∫°i</button>
            <span id="dictHint" class="subtle"></span>
          </div>
          <div id="dictOut" class="row"></div>
        </div>
        <aside class="row">
          <div class="sectionTitle">L·ªãch s·ª≠ t·ª´ ƒëi·ªÉn</div>
          <div id="dictHistory" class="subtle">Ch∆∞a c√≥.</div>
        </aside>
      </div>
    </section>

    <!-- History -->
    <section id="secHistory" class="card row" style="display:none;margin-top:16px">
      <div class="badge">L·ªãch s·ª≠ l√†m b√†i</div>
      <div class="row" style="grid-template-columns:repeat(4,1fr);gap:10px">
        <div class="stat"><span>T·ªïng l∆∞·ª£t</span><b id="hisTotal">0</b></div>
        <div class="stat"><span>ƒêi·ªÉm TB</span><b id="hisAvg">0</b></div>
        <div class="stat"><span>ƒê√∫ng (Simple ‚â•90)</span><b id="hisCorrect">0</b></div>
        <div class="stat"><span>T·ªâ l·ªá ƒë√∫ng</span><b id="hisRate">0%</b></div>
      </div>
      <table class="table" id="hisTable">
        <thead><tr><th>Th·ªùi gian</th><th>Lo·∫°i</th><th>Input</th><th>ƒêi·ªÉm/Band</th><th>K·∫øt qu·∫£</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Settings -->
    <section id="secSettings" class="card row" style="display:none;margin-top:16px">
      <div class="badge">C√†i ƒë·∫∑t API</div>
      <div class="grid" style="grid-template-columns:1.2fr .8fr">
        <div class="row">
          <label>OpenAI API Key
            <input id="apiKey" class="input" type="password" placeholder="sk-..." />
          </label>
          <div class="subtle">ƒê·ªÉ tr·ªëng ƒë·ªÉ d√πng Worker proxy.</div>
        </div>
        <div class="row">
          <label>Model
            <select id="model" class="select">
              <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
              <option value="gpt-4o">gpt-4o</option>
              <option value="gpt-4.1-mini">gpt-4.1-mini</option>
            </select>
          </label>
          <label style="margin-top:6px">Endpoint
            <input id="endpoint" class="input" value="https://api.openai.com/v1/chat/completions" />
          </label>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnSave" class="btn primary">L∆∞u</button><span id="saveMsg" class="subtle"></span>
      </div>
    </section>
  </div>

  <!-- Footer -->
  <div id="footerNav" class="footerNav">
    <div class="wrapNav"><span class="subtle">Ph√≠m t·∫Øt: ‚Üê / ‚Üí</span>
      <div style="display:flex;gap:8px">
        <button id="btnPrev" class="btn">C√¢u tr∆∞·ªõc</button>
        <button id="btnNext" class="btn primary">C√¢u ti·∫øp theo</button>
      </div>
    </div>
  </div>

  <!-- Drawer + backdrop -->
  <div id="drawer" class="drawer" aria-label="Menu">‚Ä¶</div>
  <div id="backdrop" class="backdrop"></div>

  <!-- JS duy nh·∫•t -->
  <script defer src="app.js"></script>
<!-- Onboarding Popup (SEO-safe) -->
<div id="onb-wrap" role="dialog" aria-modal="true" aria-labelledby="onb-title" aria-describedby="onb-desc"
     hidden data-nosnippet
     style="position:fixed;inset:0;z-index:99999;display:grid;place-items:center;
            background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(2px)">
  <div id="onb-card" style="width:min(560px,92%);max-height:88vh;overflow:auto;background:#fff;
                             border-radius:14px;padding:16px 16px 12px;box-shadow:0 20px 60px rgba(0,0,0,.25);
                             position:relative">
    <button id="onb-x" type="button" aria-label="ƒê√≥ng" title="ƒê√≥ng"
            style="position:absolute;top:8px;right:8px;border:0;background:transparent;cursor:pointer;
                   font-size:22px;line-height:1;opacity:.7">√ó</button>

    <div style="display:flex;align-items:center;gap:10px;margin:0 28px 6px 0">
      <div style="font-size:18px">üìò</div>
      <h3 id="onb-title" style="margin:0;font-size:18px">H∆∞·ªõng d·∫´n nhanh</h3>
    </div>

    <div id="onb-desc" style="font-size:14px;color:#4b5563;margin:0 0 10px">
      M·ªôt v√†i ghi ch√∫ ƒë·ªÉ b·∫°n d√πng hi·ªáu qu·∫£ h∆°n.
    </div>

    <!-- N·ªôi dung ƒë·ªông -->
    <div id="onb-content" style="font-size:15px;line-height:1.6;color:#111">
      <!-- s·∫Ω ƒë∆∞·ª£c JS ƒë·ªï v√†o -->
    </div>

    <!-- ƒêi·ªÅu khi·ªÉn -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:14px;gap:8px">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="onb-prev" type="button"
                style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer">
          ‚Üê Tr∆∞·ªõc
        </button>
        <button id="onb-next" type="button"
                style="padding:8px 10px;border:1px solid #1f6feb;background:#1f6feb;color:#fff;border-radius:8px;cursor:pointer">
          Ti·∫øp ‚Üí
        </button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="onb-skip" type="button"
                style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer">
          ƒê·ªÉ sau
        </button>
        <button id="onb-never" type="button"
                style="padding:8px 10px;border:1px solid #111;border-radius:8px;background:#111;color:#fff;cursor:pointer">
          ƒê√≥ng vƒ©nh vi·ªÖn
        </button>
      </div>
    </div>

    <!-- Ch·ªâ b√°o b∆∞·ªõc -->
    <div id="onb-dots" aria-hidden="true" style="display:flex;gap:6px;justify-content:center;margin-top:10px">
      <!-- js render ch·∫•m -->
    </div>
  </div>
</div>

<script>
(function(){
  // ====== C·∫•u h√¨nh nhanh ======
  const STORAGE_KEY_NEVER = "onb_never_show"; // n·∫øu "1" ‚Üí kh√¥ng hi·ªán l·∫°i
  const STORAGE_KEY_SEEN  = "onb_seen_ts";    // timestamp l·∫ßn cu·ªëi (ƒë·ªÉ b·∫°n d√πng n·∫øu mu·ªën hi·ªán ƒë·ªãnh k·ª≥)
  const FORCE_SHOW = ""; // "T" = lu√¥n hi·ªán, "F" = lu√¥n ·∫©n, "" = theo localStorage

  // ====== N·ªôi dung 4 b∆∞·ªõc ======
  const steps = [
    {
      title: "L·ªùi khuy√™n s·ª≠ d·ª•ng",
      desc: "M·ªôt v√†i nguy√™n t·∫Øc gi√∫p b·∫°n ti·∫øn b·ªô b·ªÅn v·ªØng.",
      html: `
        <ul style="margin:0 0 0 18px;padding:0">
          <li>Lu√¥n <b>t·ª± vi·∫øt tr∆∞·ªõc</b>, r·ªìi m·ªõi nh·ªù AI s·ª≠a & gi·∫£i th√≠ch.</li>
          <li>Sau khi s·ª≠a, <b>ch√©p l·∫°i c√¢u ƒë√∫ng</b> + ghi <b>quy t·∫Øc ng·ªØ ph√°p</b> r√∫t ra.</li>
          <li>T·ªïng k·∫øt l·ªói l·∫∑p (m·∫°o t·ª´, chia ƒë·ªông t·ª´, th√¨...) th√†nh <b>flashcard</b> ƒë·ªÉ √¥n.</li>
          <li>K·∫øt h·ª£p c√¢u ng·∫Øn (s·ª≠a ch√≠nh x√°c) + ƒëo·∫°n d√†i (ph√°t tri·ªÉn √Ω, coherence).</li>
        </ul>
      `
    },
    {
      title: "G·ª£i √Ω luy·ªán ƒë·ªÅu",
      desc: "L·ªãch luy·ªán g·ªçn m·ªói ng√†y.",
      html: `
        <ul style="margin:0 0 0 18px;padding:0">
          <li><b>10‚Äì15 ph√∫t</b>: d·ªãch VI‚ÜíEN ho·∫∑c vi·∫øt 5‚Äì10 c√¢u, b·∫•m <i>Ch·∫•m nhanh</i>.</li>
          <li><b>15‚Äì20 ph√∫t</b>: vi·∫øt 1 ƒëo·∫°n (Spoken/IELTS), b·∫•m <i>Ch·∫•m IELTS 4 ti√™u ch√≠</i>.</li>
          <li>ƒê·ªçc <b>gi·∫£i th√≠ch ng·ªØ ph√°p</b>, th·ª≠ <b>2‚Äì3 c√°ch di·ªÖn ƒë·∫°t</b> cho 1 √Ω.</li>
          <li>Ng√†y h√¥m sau, √¥n l·∫°i <b>l·ªói c≈©</b> tr∆∞·ªõc khi l√†m b√†i m·ªõi.</li>
        </ul>
      `
    },
    {
      title: "L·ª£i √≠ch khi d√πng ƒë√∫ng",
      desc: "T·∫≠n d·ª•ng AI nh∆∞ tr·ª£ gi·∫£ng.",
      html: `
        <ul style="margin:0 0 0 18px;padding:0">
          <li>Ph·∫£n h·ªìi <b>ngay</b> v·ªÅ ng·ªØ ph√°p, t·ª´ v·ª±ng, th√¨, c·∫•u tr√∫c c√¢u.</li>
          <li>C√≥ <b>gi·∫£i th√≠ch</b> v√¨ sao sai ‚Üí nh·ªõ quy t·∫Øc t·ªët h∆°n.</li>
          <li>ƒêa d·∫°ng h√≥a di·ªÖn ƒë·∫°t, m·ªü r·ªông collocations t·ª± nhi√™n.</li>
          <li>Luy·ªán <b>output ch·ªß ƒë·ªông</b> thay v√¨ ch·ªâ ƒë·ªçc.</li>
        </ul>
      `
    },
    {
      title: "T√°c h·∫°i & c√°ch kh·∫Øc ph·ª•c",
      desc: "Nh·ªØng r·ªßi ro th∆∞·ªùng g·∫∑p v√† c√°ch x·ª≠ l√Ω.",
      html: `
        <ul style="margin:0 0 0 18px;padding:0">
          <li><b>L·ªá thu·ªôc AI</b> ‚Üí Kh·∫Øc ph·ª•c: lu√¥n <b>vi·∫øt tr∆∞·ªõc</b>, ch·ªâ d√πng AI ƒë·ªÉ soi l·ªói.</li>
          <li><b>Thi·∫øu ph√°t tri·ªÉn √Ω</b> ‚Üí Kh·∫Øc ph·ª•c: m·ªói bu·ªïi vi·∫øt 1 ƒëo·∫°n d√†i, ch√∫ √Ω <i>coherence</i>.</li>
          <li><b>Ch·∫•m kh√¥ng tuy·ªát ƒë·ªëi</b> ‚Üí Kh·∫Øc ph·ª•c: so s√°nh v·ªõi <b>band sample</b>, h·ªèi gi√°o vi√™n khi c·∫ßn.</li>
          <li><b>Qu√™n nhanh quy t·∫Øc</b> ‚Üí Kh·∫Øc ph·ª•c: t·∫°o <b>flashcard l·ªói l·∫∑p</b> & √¥n l·∫°i sau 1‚Äì2 ng√†y.</li>
        </ul>
      `
    }
  ];

  // ====== DOM ======
  const wrap = document.getElementById("onb-wrap");
  const card = document.getElementById("onb-card");
  const title = document.getElementById("onb-title");
  const desc = document.getElementById("onb-desc");
  const content = document.getElementById("onb-content");
  const dots = document.getElementById("onb-dots");
  const btnPrev = document.getElementById("onb-prev");
  const btnNext = document.getElementById("onb-next");
  const btnSkip = document.getElementById("onb-skip");
  const btnNever = document.getElementById("onb-never");
  const btnX = document.getElementById("onb-x");

  if (!wrap || !card) return;

  // ====== Helpers ======
  let i = 0;
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  function lockScroll(on){
    document.documentElement.style.overflow = on ? "hidden" : "";
    document.body.style.overflow = on ? "hidden" : "";
  }

  function renderStep(){
    const s = steps[i];
    title.textContent = s.title;
    desc.textContent = s.desc;
    content.innerHTML = s.html;

    // dots
    dots.innerHTML = steps.map((_,idx)=>(
      `<span style="width:8px;height:8px;border-radius:999px;display:inline-block;
                    background:${idx===i?'#1f6feb':'#d1d5db'}"></span>`
    )).join("");

    // buttons
    btnPrev.disabled = (i===0);
    btnNext.textContent = (i===steps.length-1) ? "Ho√†n t·∫•t" : "Ti·∫øp ‚Üí";
  }

  function open(){
    wrap.hidden = false;
    wrap.style.display = "grid";
    lockScroll(true);
    renderStep();
  }
  function close(){
    wrap.style.display = "none";
    wrap.hidden = true;
    lockScroll(false);
  }

  // ====== Visibility logic ======
  let show = false;
  if (FORCE_SHOW==="T") show = true;
  else if (FORCE_SHOW==="F") show = false;
  else show = (localStorage.getItem(STORAGE_KEY_NEVER)!=="1");

  if (show) open();

  // ====== Events ======
  btnPrev.onclick = ()=>{ i = clamp(i-1,0,steps.length-1); renderStep(); };
  btnNext.onclick = ()=>{
    if (i < steps.length-1){ i++; renderStep(); }
    else { // ho√†n t·∫•t
      localStorage.setItem(STORAGE_KEY_SEEN, Date.now().toString());
      close();
    }
  };
  btnSkip.onclick = ()=> close();
  btnNever.onclick = ()=>{
    localStorage.setItem(STORAGE_KEY_NEVER, "1");
    localStorage.setItem(STORAGE_KEY_SEEN, Date.now().toString());
    close();
  };
  btnX.onclick = ()=> close();

  // Click ra n·ªÅn ƒë·ªÉ ƒë√≥ng
  wrap.addEventListener("click", (e)=>{ if(e.target===wrap) close(); });

  // Ph√≠m t·∫Øt
  document.addEventListener("keydown", (e)=>{
    if (wrap.hidden) return;
    if (e.key==="Escape") close();
    if (e.key==="ArrowRight") btnNext.click();
    if (e.key==="ArrowLeft") btnPrev.click();
  });

  // Dark-mode nh·∫π (n·∫øu trang b·∫≠t .dark)
  const root = document.documentElement;
  const observer = new MutationObserver(()=>{
    if (root.classList.contains("dark")){
      card.style.background = "#0b1220";
      card.style.color = "#e5e7eb";
    } else {
      card.style.background = "#fff";
      card.style.color = "#111";
    }
  });
  observer.observe(root, { attributes:true, attributeFilter:["class"] });
  // init theme
  if (root.classList.contains("dark")){
    card.style.background = "#0b1220";
    card.style.color = "#e5e7eb";
  }
})();
</script>
</body>
</html>
