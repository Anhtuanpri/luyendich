<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI Luy·ªán D·ªãch ‚Ä¢ Ch·∫•m ƒëi·ªÉm ‚Ä¢ T·ª´ ƒëi·ªÉn ng·ªØ c·∫£nh (IPA UK/US)</title>
<meta name="description" content="Luy·ªán d·ªãch Vi·ªát‚ÜíAnh v·ªõi AI ch·∫•m l·ªói, g·ª£i √Ω c·∫•u tr√∫c, trang t·ª´ ƒëi·ªÉn ng·ªØ c·∫£nh k√®m IPA Anh/M·ªπ, v√≠ d·ª• theo nghƒ©a.">
<link rel="canonical" href="https://example.com/ai-luyen-dich">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f7f8fb; --panel:#ffffff; --ink:#0f1a2b; --muted:#6a7286; --line:#e8ecf3;
  --brand:#3a63ff; --brand2:#6f8bff; --ok:#12b886; --warn:#f59f00; --bad:#fa5252;
  --soft:0 8px 28px rgba(16,24,40,.08),0 2px 8px rgba(16,24,40,.06); --radius:14px;
}
:root.dark{ --bg:#0f1216; --panel:#171a1f; --ink:#e9edf6; --muted:#a1a8b5; --line:#262b33; --brand:#6f8bff; --brand2:#8ea2ff; --soft:0 10px 28px rgba(0,0,0,.35),0 2px 8px rgba(0,0,0,.25) }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.65 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
.container{width:min(1200px,94vw);margin:22px auto 90px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
h1{font-size:22px;margin:0 0 4px 0;font-weight:800}
.lead{color:var(--muted);font-size:13px;margin:0}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab, .themeToggle{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--ink);cursor:pointer;box-shadow:var(--soft)}
.tab.active{outline:2px solid rgba(58,99,255,.18)}
.grid{display:grid;gap:16px} @media(min-width:980px){.grid.two{grid-template-columns:1.15fr .85fr}}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--soft)}
.sectionTitle{font-weight:800;margin:0 0 6px}
.row{display:grid;gap:10px}
.input,.select,textarea{width:100%;background:#fff;color:#0f1a2b;border:1px solid #dfe5f0;border-radius:12px;padding:10px 12px;outline:none}
textarea{min-height:110px;resize:vertical}
:root.dark .input,:root.dark .select,:root.dark textarea{background:#121418;color:#e9edf6;border:1px solid #2a2f37}
.input:focus,.select:focus,textarea:focus{border-color:#9db1ff;box-shadow:0 0 0 3px rgba(58,99,255,.15)}
.btn{appearance:none;border:1px solid #dfe5f0;background:#fff;color:#0f1a2b;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--soft)}
.btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;border-color:transparent}
:root.dark .btn{background:#171a1f;color:#e9edf6;border:1px solid #2a2f37}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#f2f6ff;color:#29407a;border:1px solid #e3ebff}
:root.dark .badge{background:#1a2030;color:#cdd6ff;border-color:#2a3350}
.subtle{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
.progress{height:10px;background:#e9edf8;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,#6f8cff,#3a63ff)}
.score{font-weight:800}.score.good{color:var(--ok)}.score.mid{color:var(--warn)}.score.bad{color:var(--bad)}
.kv{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:flex-start}
.kv b{color:#2b395a} :root.dark .kv b{color:#cdd6ff}
.boxVI{padding:14px;border:1px dashed #d9e1f3;border-radius:12px;background:#fbfdff}
:root.dark .boxVI{border-color:#2a2f37;background:#111317}
.footerNav{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.75);backdrop-filter:blur(10px);border-top:1px solid var(--line)}
:root.dark .footerNav{background:rgba(20,22,27,.65)}
.wrapNav{width:min(1200px,94vw);margin:0 auto;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.errtag{display:inline-block;margin-right:6px;margin-bottom:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#f7f9ff}
:root.dark .errtag{background:#141826}
.sense{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fbfdff}
:root.dark .sense{background:#111317}
.ipa{font-family: "Times New Roman",serif;font-style:italic}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>AI Luy·ªán D·ªãch ‚Ä¢ Ch·∫•m ‚Ä¢ T·ª´ ƒëi·ªÉn</h1>
      <p class="lead">Giao di·ªán s√°ng nh·∫π/t·ªëi x√°m. T·ª´ ƒëi·ªÉn ng·ªØ c·∫£nh (IPA UK/US) & v√≠ d·ª• theo nghƒ©a.</p>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabPractice">Luy·ªán t·∫≠p</button>
      <button class="tab" id="tabGenerate">T·∫°o c√¢u (AI)</button>
      <button class="tab" id="tabImport">Nh·∫≠p danh s√°ch</button>
      <button class="tab" id="tabDictionary">T·ª´ ƒëi·ªÉn</button>
      <button class="tab" id="tabSettings">C√†i ƒë·∫∑t API</button>
      <button id="toggleTheme" class="themeToggle" title="ƒê·ªïi giao di·ªán">üå§Ô∏è</button>
    </div>
  </header>

  <!-- PRACTICE -->
  <section id="secPractice" class="grid two" style="margin-top:16px">
    <div class="card row">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span class="badge">B√†i luy·ªán</span><span id="counter" class="subtle">C√¢u 1/1</span>
      </div>
      <div class="progress"><div id="progbar" style="width:0%"></div></div>
      <div class="row">
        <div class="sectionTitle">C√¢u ti·∫øng Vi·ªát</div>
        <div id="viBox" class="boxVI mono">‚Äî</div>
      </div>
      <div class="row">
        <div class="sectionTitle">B·∫£n d·ªãch c·ªßa b·∫°n</div>
        <textarea id="answer" class="mono" placeholder="G√µ ti·∫øng Anh ·ªü ƒë√¢y..."></textarea>
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr;gap:10px">
        <button id="btnSuggest" class="btn">G·ª£i √Ω</button>
        <button id="btnGrade" class="btn primary">Ch·∫•m</button>
      </div>
      <div id="hint" class="subtle"></div>
    </div>

    <div class="row">
      <div class="card row">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="sectionTitle">G·ª£i √Ω t·ª´ AI Teacher</div>
          <div class="subtle"><label><input type="checkbox" id="toggleViGloss"> Hi·ªán d·ªãch VI</label></div>
        </div>
        <div class="kv"><b>Key idea</b><div id="gIdea" class="subtle">‚Äî</div></div>
        <div class="kv"><b>Vocabulary</b><div id="gVocab" class="subtle">‚Äî</div></div>
        <div class="kv"><b>Grammar</b><div id="gGrammar" class="subtle">‚Äî</div></div>
      </div>

      <div class="card row">
        <div class="sectionTitle">K·∫øt qu·∫£ ch·∫•m</div>
        <div id="gradeBox" class="subtle">Ch∆∞a ch·∫•m.</div>
      </div>
    </div>
  </section>

  <!-- GENERATE -->
  <section id="secGenerate" class="card row" style="display:none;margin-top:16px">
    <div class="badge">T·∫°o c√¢u ti·∫øng Vi·ªát b·∫±ng AI</div>
    <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
      <div class="row"><label>Ch·ªß ƒë·ªÅ<input id="topic" class="input" placeholder="present continuous / travel ..."></label></div>
      <div class="row"><label>M·ª©c ƒë·ªô<select id="level" class="select"><option>A2</option><option selected>B1</option><option>B2</option><option>C1</option></select></label></div>
      <div class="row"><label>S·ªë c√¢u<input id="count" type="number" class="input" value="10" min="1" max="40"></label></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnGen" class="btn primary">T·∫°o danh s√°ch</button>
      <button id="btnUseList" class="btn">Thay v√†o b√†i luy·ªán</button>
      <span id="genMsg" class="subtle"></span>
    </div>
    <div id="genList" class="row"></div>
  </section>

  <!-- IMPORT -->
  <section id="secImport" class="card row" style="display:none;margin-top:16px">
    <div class="badge">Nh·∫≠p nhi·ªÅu c√¢u (m·ªói d√≤ng m·ªôt c√¢u)</div>
    <textarea id="bulk" class="mono" placeholder="D√°n c√¢u Vi·ªát v√†o ƒë√¢y, m·ªói d√≤ng m·ªôt c√¢u."></textarea>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnImport" class="btn primary">Thay v√†o b√†i luy·ªán</button>
      <span class="subtle">H·ªó tr·ª£ ~100 c√¢u/l·∫ßn.</span>
    </div>
  </section>

  <!-- DICTIONARY -->
  <section id="secDictionary" class="card row" style="display:none;margin-top:16px">
    <div class="badge">T·ª´ ƒëi·ªÉn ng·ªØ c·∫£nh (IPA UK/US + v√≠ d·ª• theo nghƒ©a)</div>
    <div class="grid" style="grid-template-columns:1.1fr .9fr">
      <div class="row">
        <label for="q">Tra t·ª´/c·ª•m t·ª´</label>
        <input id="q" class="input" placeholder="vd: anxiety, take off, run into...">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnLookup" class="btn primary">Tra</button>
          <button id="btnLookupFromVI" class="btn">D·ªãch c√¢u VI ‚Üí EN theo ng·ªØ c·∫£nh</button>
          <span id="dictHint" class="subtle"></span>
        </div>
        <div id="dictOut" class="row"></div>
      </div>
      <aside class="row">
        <div class="sectionTitle">L·ªãch s·ª≠ g·∫ßn ƒë√¢y</div>
        <div id="dictHistory" class="subtle"></div>
      </aside>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="secSettings" class="card row" style="display:none;margin-top:16px">
    <div class="badge">C√†i ƒë·∫∑t API</div>
    <div class="grid" style="grid-template-columns:1.2fr .8fr">
      <div class="row"><label>OpenAI API Key<input id="apiKey" class="input" type="password" placeholder="sk-..."></label><div class="subtle">Khi public, h√£y d√πng proxy ƒë·ªÉ ·∫©n key.</div></div>
      <div class="row"><label>Model<select id="model" class="select"><option value="gpt-4o-mini" selected>gpt-4o-mini</option><option value="gpt-4o">gpt-4o</option><option value="gpt-4.1-mini">gpt-4.1-mini</option></select></label>
        <label style="margin-top:6px">Endpoint<input id="endpoint" class="input" value="https://api.openai.com/v1/chat/completions"></label></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnSave" class="btn primary">L∆∞u</button>
      <span id="saveMsg" class="subtle"></span>
    </div>
  </section>
</div>

<div class="footerNav">
  <div class="wrapNav">
    <span class="subtle">Ph√≠m t·∫Øt: ‚Üê / ‚Üí</span>
    <div style="display:flex;gap:8px">
      <button id="btnPrev" class="btn">C√¢u tr∆∞·ªõc</button>
      <button id="btnNext" class="btn primary">C√¢u ti·∫øp theo</button>
    </div>
  </div>
</div>

<script>
/* ========== Theme ========== */
const root=document.documentElement;
if(localStorage.getItem('theme')==='dark'||(!localStorage.getItem('theme')&&matchMedia('(prefers-color-scheme: dark)').matches)){root.classList.add('dark');document.getElementById('toggleTheme').textContent='üåô';}
document.getElementById('toggleTheme').onclick=()=>{root.classList.toggle('dark');const d=root.classList.contains('dark');localStorage.setItem('theme',d?'dark':'light');document.getElementById('toggleTheme').textContent=d?'üåô':'üå§Ô∏è';};

/* ========== Helpers & storage ========== */
const $=s=>document.querySelector(s);const el=(t,c,h)=>{const x=document.createElement(t);if(c)x.className=c;if(h!=null)x.innerHTML=h;return x;};
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const escapeHtml=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const store={ get items(){try{return JSON.parse(localStorage.getItem('ls_items')||'[]')}catch(_){return[]}}, set items(v){localStorage.setItem('ls_items',JSON.stringify(v||[]))},
  get idx(){return parseInt(localStorage.getItem('ls_idx')||'0',10)||0}, set idx(v){localStorage.setItem('ls_idx',String(v|0))},
  get attempts(){try{return JSON.parse(localStorage.getItem('ls_attempts')||'[]')}catch(_){return[]}}, set attempts(v){localStorage.setItem('ls_attempts',JSON.stringify(v||[]))},
  get key(){return localStorage.getItem('ai_key')||''}, set key(v){localStorage.setItem('ai_key',v||'')},
  get mdl(){return localStorage.getItem('ai_model')||'gpt-4o-mini'}, set mdl(v){localStorage.setItem('ai_model',v||'gpt-4o-mini')},
  get ep(){return localStorage.getItem('ai_ep')||'https://api.openai.com/v1/chat/completions'}, set ep(v){localStorage.setItem('ai_ep',v||'https://api.openai.com/v1/chat/completions')},
  get dictHist(){try{return JSON.parse(localStorage.getItem('dict_hist')||'[]')}catch(_){return[]}}, set dictHist(v){localStorage.setItem('dict_hist',JSON.stringify(v||[]))}
};

/* ========== Tabs ========== */
const tabs=[['#tabPractice','#secPractice'],['#tabGenerate','#secGenerate'],['#tabImport','#secImport'],['#tabDictionary','#secDictionary'],['#tabSettings','#secSettings']];
tabs.forEach(([b,s])=>$(b).onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('section.card,section.grid').forEach(x=>x.style.display='none');$(b).classList.add('active');$(s).style.display='grid';});

/* ========== Data & render ========== */
let items=store.items.length?store.items:[
  "Ch√∫ng t√¥i ƒëang xem phim ·ªü r·∫°p chi·∫øu phim, phim r·∫•t hay.",
  "H·ªç ƒëang x√¢y m·ªôt ng√¥i nh√† m·ªõi, n√≥ s·∫Ω r·∫•t l·ªõn.",
  "T√¥i ƒëang h·ªçc l√°i xe, t√¥i r·∫•t lo l·∫Øng."
];
let idx=clamp(store.idx,0,items.length-1);

function renderPractice(){
  const total=items.length||1; idx=clamp(idx,0,total-1);
  $('#viBox').textContent=items[idx]||'‚Äî'; $('#answer').value='';
  $('#gIdea').textContent='‚Äî'; $('#gVocab').textContent='‚Äî'; $('#gGrammar').textContent='‚Äî';
  $('#gradeBox').textContent='Ch∆∞a ch·∫•m.'; $('#counter').textContent=`C√¢u ${idx+1}/${total}`;
  $('#progbar').style.width=`${Math.round(((idx+1)/total)*100)}%`;
  store.items=items; store.idx=idx;
}
renderPractice();
$('#btnPrev').onclick=()=>{idx=clamp(idx-1,0,items.length-1);renderPractice();};
$('#btnNext').onclick=()=>{idx=clamp(idx+1,0,items.length-1);renderPractice();};
window.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')$('#btnPrev').click(); if(e.key==='ArrowRight')$('#btnNext').click();});

/* ========== API call ========== */
async function callOpenAI(systemPrompt,userPrompt,max_tokens=700){
  const key=store.key; if(!key) throw new Error('Ch∆∞a c√≥ API key (tab C√†i ƒë·∫∑t).');
  const res=await fetch(store.ep,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
    body:JSON.stringify({model:store.mdl,temperature:0.2,max_tokens,messages:[{role:'system',content:systemPrompt},{role:'user',content:userPrompt}]})});
  if(!res.ok){const t=await res.text(); throw new Error('API l·ªói '+res.status+' ‚Äî '+t);}
  const data=await res.json(); return data.choices?.[0]?.message?.content||'';
}
const parseJSON=txt=>{try{return JSON.parse(txt.trim().replace(/^```json|```$/g,''))}catch(_){return null}};
function setBusy(on){document.querySelectorAll('button').forEach(b=>b.disabled=!!on);}

/* ========== Suggest (EN vocab, optional VI gloss) ========== */
$('#btnSuggest').onclick=async()=>{
  const vi=items[idx];
  const sys=`B·∫°n l√† AI Teacher. Tr·ª£ gi√∫p d·ªãch VI‚ÜíEN b·∫±ng g·ª£i √Ω ng·∫Øn g·ªçn.
Tr·∫£ v·ªÅ JSON duy nh·∫•t:
{"idea_en":"‚Ä¶","idea_vi":"‚Ä¶","vocab_en":["‚Ä¶"],"vocab_vi":["‚Ä¶"],"grammar_en":["‚Ä¶"],"grammar_vi":["‚Ä¶"]}`;
  const usr=`Vietnamese sentence: ${vi}`;
  try{
    setBusy(true);$('#hint').textContent='ƒêang g·ª£i √Ω...';
    const out=await callOpenAI(sys,usr,400); const js=parseJSON(out); if(!js) throw new Error('K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.');
    const showVI=$('#toggleViGloss').checked;
    $('#gIdea').textContent = js.idea_en + (showVI && js.idea_vi? ` ‚Äî ${js.idea_vi}`:'');
    $('#gVocab').textContent = (js.vocab_en||[]).join(', ') + (showVI && js.vocab_vi?.length? ` ‚Äî ${js.vocab_vi.join(', ')}`:'');
    $('#gGrammar').textContent = (js.grammar_en||[]).join('; ') + (showVI && js.grammar_vi?.length? ` ‚Äî ${js.grammar_vi.join('; ')}`:'');
    $('#hint').textContent='ƒê√£ g·ª£i √Ω.'; setTimeout(()=>$('#hint').textContent='',1200);
  }catch(err){$('#hint').textContent=err.message;} finally{setBusy(false);}
};

/* ========== Grade ========== */
const CORRECT_THRESHOLD=80;
$('#btnGrade').onclick=async()=>{
  const vi=items[idx]; const en=($('#answer').value||'').trim(); if(!en){$('#hint').textContent='B·∫°n ch∆∞a nh·∫≠p b·∫£n d·ªãch.';return;}
  const sys=`You are an expert English teacher & IELTS examiner.
Return STRICT JSON ONLY:
{"score":0-100,"band":4.0-9.0,"verdict":"Good|Okay|Poor",
 "errors":[{"type":"tense|sva|articles|prepositions|word choice|collocation|punctuation|spelling|other","from":"‚Ä¶","to":"‚Ä¶","explain_vi":"‚Ä¶"}],
 "suggest_sentence":"‚Ä¶","structure_advice":"‚Ä¶"}
Use Vietnamese for explanations.`; 
  const usr=`C√¢u g·ªëc (VI): ${vi}\nB√†i l√†m (EN): ${en}\nCh·∫•m theo schema.`;
  try{
    setBusy(true);$('#hint').textContent='ƒêang ch·∫•m...';
    const out=await callOpenAI(sys,usr,700); const r=parseJSON(out); if(!r||typeof r.score!=='number') throw new Error('K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.');
    const cls=r.score>=85?'good':(r.score>=65?'mid':'bad'); const errs=Array.isArray(r.errors)?r.errors:[];
    const list=errs.map(e=>`<span class="errtag mono">[${escapeHtml(e.type||'')}] "${escapeHtml(e.from||'')}" ‚Üí "${escapeHtml(e.to||'')}" ‚Äî ${escapeHtml(e.explain_vi||'')}</span>`).join('');
    $('#gradeBox').innerHTML=`
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <div class="score ${cls}">ƒêi·ªÉm: ${Math.round(r.score)}</div>
        <span class="badge">Band: ${r.band??'-'}</span>
        <span class="badge">ƒê√°nh gi√°: ${escapeHtml(r.verdict||'-')}</span>
      </div>
      ${r.suggest_sentence?`<div class="row"><b>C√¢u s·ª≠a ƒë·ªÅ xu·∫•t</b><div class="mono" style="padding:10px;border:1px dashed var(--line);border-radius:10px">${escapeHtml(r.suggest_sentence)}</div></div>`:''}
      ${r.structure_advice?`<div class="row"><b>C·∫•u tr√∫c n√™n d√πng</b><div class="mono" style="padding:10px;border:1px dashed var(--line);border-radius:10px">${escapeHtml(r.structure_advice)}</div></div>`:''}
      ${errs.length?`<div class="row"><b>L·ªói c·ª• th·ªÉ</b><div>${list}</div></div>`:''}
    `;
    $('#hint').textContent='ƒê√£ ch·∫•m.'; setTimeout(()=>$('#hint').textContent='',1200);
    const attempts=store.attempts; attempts.push({at:Date.now(),vi,en,score:r.score,band:r.band,verdict:r.verdict,error_types:errs.map(e=>e.type||'other'),correct:r.score>=CORRECT_THRESHOLD}); store.attempts=attempts;
  }catch(err){$('#gradeBox').innerHTML=`<div class="mono" style="padding:10px;border:1px dashed var(--line);border-radius:10px">L·ªói: ${escapeHtml(err.message)}</div>`;$('#hint').textContent='';}
  finally{setBusy(false);}
};

/* ========== Generate & Import ========== */
let genCache=[];
$('#btnGen').onclick=async()=>{
  const topic=($('#topic').value||'giao ti·∫øp h·∫±ng ng√†y').trim(), level=$('#level').value, count=clamp(parseInt($('#count').value||'10',10),1,40);
  const sys=`Sinh N c√¢u TI·∫æNG VI·ªÜT (ng·∫Øn, t·ª± nhi√™n) ƒë·ªô kh√≥ ${level}, ƒëa d·∫°ng kh·∫≥ng ƒë·ªãnh/ph·ªß ƒë·ªãnh/c√¢u h·ªèi. Tr·∫£ v·ªÅ JSON {"sentences":["‚Ä¶"]}.`;
  try{
    setBusy(true);$('#genMsg').textContent='ƒêang t·∫°o...';
    const out=await callOpenAI('B·∫°n l√† AI Teacher cho ng∆∞·ªùi Vi·ªát.',sys+` N=${count}\nCh·ªß ƒë·ªÅ: ${topic}`,600);
    const js=parseJSON(out); const arr=js?.sentences?.filter(s=>typeof s==='string'&&s.trim())||[];
    if(!arr.length) throw new Error('AI kh√¥ng tr·∫£ v·ªÅ danh s√°ch h·ª£p l·ªá.');
    genCache=arr; const box=$('#genList'); box.innerHTML=''; arr.forEach((s,i)=>box.append(el('div','mono',`${i+1}. ${escapeHtml(s)}`)));
    $('#genMsg').textContent=`ƒê√£ t·∫°o ${arr.length} c√¢u. B·∫•m "Thay v√†o b√†i luy·ªán".`;
  }catch(err){$('#genMsg').textContent=err.message;} finally{setBusy(false);}
};
$('#btnUseList').onclick=()=>{ if(!genCache.length){$('#genMsg').textContent='Ch∆∞a c√≥ danh s√°ch.';return;} items=[...genCache]; idx=0; store.items=items; store.idx=idx; $('#tabPractice').click(); renderPractice(); };
$('#btnImport').onclick=()=>{ const lines=($('#bulk').value||'').split('\n').map(s=>s.trim()).filter(Boolean); if(!lines.length){alert('B·∫°n ch∆∞a nh·∫≠p c√¢u n√†o.');return;} items=lines.slice(0,100); idx=0; store.items=items; store.idx=idx; $('#tabPractice').click(); renderPractice(); };

/* ========== Settings ========== */
$('#apiKey').value=store.key; $('#model').value=store.mdl; $('#endpoint').value=store.ep;
$('#btnSave').onclick=()=>{store.key=$('#apiKey').value.trim();store.mdl=$('#model').value;store.ep=$('#endpoint').value.trim();$('#saveMsg').textContent='ƒê√£ l∆∞u.';setTimeout(()=>$('#saveMsg').textContent='',1200);};

/* ========== Dictionary ========== */
function renderHistory(){ const hist=store.dictHist.slice(-12).reverse(); $('#dictHistory').innerHTML = hist.length? hist.map(w=>`<span class="errtag">${escapeHtml(w)}</span>`).join('') : 'Ch∆∞a c√≥.'; }
renderHistory();

function renderDictionary(data){
  const box=$('#dictOut'); box.innerHTML='';
  const head = el('div','row'); 
  head.append(el('div',null,`<h2 class="sectionTitle" style="margin:0">${escapeHtml(data.headword)} <small class="subtle">(${data.pos.join(', ')||''})</small></h2>`));
  head.append(el('div','subtle',`IPA UK: <span class="ipa">/${escapeHtml(data.ipa_uk||'-')}/</span> &nbsp;‚Ä¢&nbsp; IPA US: <span class="ipa">/${escapeHtml(data.ipa_us||'-')}/</span>`));
  box.append(head);

  (data.senses||[]).forEach((s,i)=>{
    const d=el('div','sense row');
    d.append(el('div','',`<b>${i+1}. ${escapeHtml(s.gloss_en)}</b> <span class="subtle">‚Äî ${escapeHtml(s.gloss_vi||'')}</span> ${s.tags?.length? `<span class="subtle">(${s.tags.join(', ')})</span>`:''}`));
    if(s.examples?.length){
      const ex = s.examples.map(e=>`<div class="mono">‚Ä¢ ${escapeHtml(e.en)} <span class="subtle">‚Äî ${escapeHtml(e.vi||'')}</span></div>`).join('');
      d.append(el('div','row',`<div><b>V√≠ d·ª•</b></div>${ex}`));
    }
    if(s.collocations?.length) d.append(el('div','subtle',`<b>Collocations:</b> ${escapeHtml(s.collocations.join(', '))}`));
    box.append(d);
  });
  if(data.synonyms?.length || data.antonyms?.length || data.phrasals?.length){
    const meta = el('div','row');
    if(data.synonyms?.length) meta.append(el('div','subtle',`<b>Synonyms:</b> ${escapeHtml(data.synonyms.join(', '))}`));
    if(data.antonyms?.length) meta.append(el('div','subtle',`<b>Antonyms:</b> ${escapeHtml(data.antonyms.join(', '))}`));
    if(data.phrasals?.length) meta.append(el('div','subtle',`<b>Phrasal verbs:</b> ${escapeHtml(data.phrasals.join(', '))}`));
    box.append(meta);
  }
}

async function lookupDictionary(q){
  const sys=`B·∫°n l√† t·ª´ ƒëi·ªÉn h·ªçc t·∫≠p EN‚áÑVI.
Tr·∫£ v·ªÅ JSON duy nh·∫•t theo schema:
{
 "headword":"", "pos":["verb","noun"], "ipa_uk":"", "ipa_us":"", 
 "senses":[
   {"gloss_en":"", "gloss_vi":"", "tags":["everyday","informal"], 
    "examples":[{"en":"", "vi":""},{"en":"", "vi":""}],
    "collocations":["...","..."]}
 ],
 "synonyms":["..."], "antonyms":["..."], "phrasals":["..."]
}
Gi·∫£i th√≠ch ng·∫Øn g·ªçn, v√≠ d·ª• t·ª± nhi√™n, ch√∫ √Ω nhi·ªÅu NG·ªÆ C·∫¢NH kh√°c nhau.`;
  const usr=`Headword or phrase: ${q}\nN·∫øu l√† c·ª•m ƒë·ªông t·ª´, n√™u ƒë·∫ßy ƒë·ªß senses/phrasals li√™n quan.`;
  const out=await callOpenAI(sys,usr,900); const js=parseJSON(out); if(!js) throw new Error('K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.'); return js;
}

$('#btnLookup').onclick=async()=>{
  const q=($('#q').value||'').trim(); if(!q){$('#dictHint').textContent='Nh·∫≠p t·ª´/c·ª•m t·ª´ c·∫ßn tra.';return;}
  try{
    setBusy(true); $('#dictHint').textContent='ƒêang tra...';
    const data=await lookupDictionary(q); renderDictionary(data);
    const hist=store.dictHist; if(!hist.includes(q)) hist.push(q); store.dictHist=hist.slice(-50); renderHistory();
    $('#dictHint').textContent=''; 
  }catch(err){ $('#dictOut').innerHTML=`<div class="mono">L·ªói: ${escapeHtml(err.message)}</div>`; $('#dictHint').textContent=''; }
  finally{ setBusy(false); }
};

/* Bonus: d·ªãch c√¢u VI ‚Üí EN gi√†u ng·ªØ c·∫£nh */
$('#btnLookupFromVI').onclick=async()=>{
  const vi=($('#viBox').textContent||'').trim(); if(!vi){$('#dictHint').textContent='Kh√¥ng c√≥ c√¢u Vi·ªát hi·ªán t·∫°i.';return;}
  try{
    setBusy(true); $('#dictHint').textContent='ƒêang d·ªãch theo ng·ªØ c·∫£nh...';
    const sys=`B·∫°n l√† d·ªãch gi·∫£ EN‚áÑVI. D·ªãch c√¢u TI·∫æNG VI·ªÜT sang ti·∫øng Anh v·ªõi 3 ph∆∞∆°ng √°n theo NG·ªÆ C·∫¢NH kh√°c nhau (trung t√≠nh, th√¢n m·∫≠t, trang tr·ªçng).
Tr·∫£ v·ªÅ JSON {"variants":[{"style":"neutral|casual|formal","en":"‚Ä¶","explain_vi":"‚Ä¶"}]}.`;
    const out=await callOpenAI(sys,vi,500); const js=parseJSON(out);
    const box=$('#dictOut'); box.innerHTML='<h3 class="sectionTitle">G·ª£i √Ω d·ªãch theo ng·ªØ c·∫£nh</h3>';
    (js?.variants||[]).forEach(v=>{
      box.append(el('div','sense row',`<b>${escapeHtml(v.style||'')}</b><div class="mono">${escapeHtml(v.en||'')}</div><div class="subtle">${escapeHtml(v.explain_vi||'')}</div>`));
    });
    $('#dictHint').textContent='';
  }catch(err){ $('#dictOut').innerHTML=`<div class="mono">L·ªói: ${escapeHtml(err.message)}</div>`; $('#dictHint').textContent='';}
  finally{ setBusy(false); }
};
</script>
</body>
</html>
