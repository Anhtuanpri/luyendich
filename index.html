
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GI√ÅO VI√äN AI - CH√öC M·ªåI NG∆Ø·ªúI H·ªåC T·∫¨P VUI V·∫∫</title>
<meta name="description" content="T·∫°o c√¢u theo band A2/B1/B2/C1 (c√≥ ng·ªØ c·∫£nh), t·∫°o vƒÉn n√≥i & vƒÉn IELTS (Task1/Task2). Luy·ªán d·ªãch, ch·∫•m 10‚Äì100 & IELTS 4 ti√™u ch√≠. Donate QR hard-code.">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#f7f8fb;--panel:#fff;--ink:#0f1a2b;--muted:#6a7286;--line:#e9ecf3;--brand:#3a63ff;--brand2:#6f8bff;--ok:#12b886;--warn:#f59f00;--bad:#fa5252;--soft:0 8px 28px rgba(16,24,40,.08),0 2px 8px rgba(16,24,40,.06);--r:14px;--green:#0ead69;--red:#e03131;--lh:1.6em;--footer-h:78px}
:root.dark{--bg:#0f1216;--panel:#171a1f;--ink:#e9edf6;--muted:#a1a8b5;--line:#262b33;--brand:#6f8bff;--brand2:#8ea2ff;--soft:0 10px 28px rgba(0,0,0,.35),0 2px 8px rgba(0,0,0,.25)}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.65 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;padding-bottom:var(--footer-h);scroll-padding-bottom:calc(var(--footer-h) + 10px)}
.container{width:min(1200px,94vw);margin:18px auto;min-height:calc(100dvh - var(--footer-h) - 36px)}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
h1{font-size:22px;margin:0;font-weight:800}.lead{color:var(--muted);font-size:13px;margin:2px 0 0}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab,.themeToggle,.hamburger{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--ink);cursor:pointer;box-shadow:var(--soft)}
.tab.active{outline:2px solid rgba(58,99,255,.18)}
.grid{display:grid;gap:16px}@media(min-width:980px){.grid.two{grid-template-columns:1.15fr .85fr}}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);padding:16px;box-shadow:var(--soft)}
.sectionTitle{font-weight:800;margin:0 0 6px}.row{display:grid;gap:10px}
.input,.select,textarea{width:100%;background:#fff;color:#0f1a2b;border:1px solid #dfe5f0;border-radius:12px;padding:10px 12px;outline:none}
textarea{min-height:110px;resize:vertical}
:root.dark .input,:root.dark .select,:root.dark textarea{background:#121418;color:#e9edf6;border:1px solid #2a2f37}
.input:focus,.select:focus,textarea:focus{border-color:#9db1ff;box-shadow:0 0 0 3px rgba(58,99,255,.15)}
.btn{appearance:none;border:1px solid #dfe5f0;background:#fff;color:#0f1a2b;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--soft)}
.btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;border-color:transparent}
:root.dark .btn{background:#171a1f;color:#e9edf6;border:1px solid #2a2f37}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#f2f6ff;color:#29407a;border:1px solid #e3ebff}
:root.dark .badge{background:#1a2030;color:#cdd6ff;border-color:#2a3350}
.subtle{color:var(--muted)}.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
.progress{height:10px;background:#e9edf8;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,#6f8cff,#3a63ff)}
.kv{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:flex-start}
.boxVI{padding:14px;border:1px dashed #d9e1f3;border-radius:12px;background:#fbfdff}
.boxVI.limit10{line-height:var(--lh);max-height:calc(var(--lh) * 10);overflow:auto}
:root.dark .boxVI{background:#111317;border-color:#2a2f37}
.errtag{display:inline-block;margin:4px 6px 0 0;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#f7f9ff}
:root.dark .errtag{background:#141826}
.table{width:100%;border-collapse:collapse}.table th,.table td{padding:8px;border-bottom:1px solid var(--line)}

/* ==== DIFF HIGHLIGHT (ƒë√£ s·ª≠a) ==== */
/* Mode chung */
.diff{line-height:1.75}
/* SIMPLE: luy·ªán d·ªãch c√¢u ng·∫Øn ‚Äì ƒë·ªè/xanh + g·∫°ch d√≤ng ph·∫ßn sai */
.diff.simple .del{background:rgba(224,49,49,.16);color:#e03131;text-decoration:line-through;border-radius:4px;padding:1px 2px}
.diff.simple .ins{background:rgba(14,173,105,.16);color:#0ead69;border-radius:4px;padding:1px 2px}
.diff.simple .ellipsis{color:var(--muted)}
/* WRITING/SPOKEN: 3 m√†u ‚Äì KH√îNG g·∫°ch, theo band */
.diff.writing span{border-radius:4px;padding:1px 2px}
.diff.writing .bad{background:rgba(250,82,82,.18);color:#e03131}      /* <5.0 */
.diff.writing .near{background:rgba(245,157,0,.22);color:#9a6b00}    /* 5.0‚Äì6.5 */
.diff.writing .good{background:rgba(18,184,134,.18);color:#0ead69}   /* 7.0‚Äì9.0 */

/* Drawer/Profile */
.drawer{position:fixed;inset:0 0 0 auto;width:min(420px,92vw);background:var(--panel);border-left:1px solid var(--line);box-shadow:var(--soft);transform:translateX(105%);transition:.25s;z-index:60;padding:16px}
.drawer.show{transform:translateX(0)}.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:.2s;z-index:55}
.backdrop.show{opacity:1;pointer-events:auto}
.avatar{width:96px;height:96px;border-radius:50%;object-fit:cover;border:2px solid var(--line);cursor:pointer}
.stat{display:flex;justify-content:space-between;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fbfdff}
:root.dark .stat{background:#111317}

/* Footer c·ªë ƒë·ªãnh + ƒëo chi·ªÅu cao th·∫≠t */
.footerNav{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.78);backdrop-filter:blur(10px);border-top:1px solid var(--line);z-index:50}
:root.dark .footerNav{background:rgba(20,22,27,.65)}
.wrapNav{width:min(1200px,94vw);margin:0 auto;padding:12px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px}

/* Chat AI */
.chat{border:1px solid var(--line);border-radius:12px;padding:10px;max-height:420px;overflow:auto;background:var(--panel)}
.msg{display:flex;gap:10px;margin:6px 0}
.msg.me{justify-content:flex-end}
.bubble{padding:10px 12px;border-radius:12px;border:1px solid var(--line);max-width:80%}
.me .bubble{background:#eaf0ff}
:root.dark .me .bubble{background:#141b2b}
.type{border-right:2px solid var(--ink);animation:caret 1s steps(1) infinite}
@keyframes caret{50%{border-color:transparent}}

/* Khu k·∫øt qu·∫£ d√†i c√≥ scroll ri√™ng */
.scrollBox{max-height:260px;overflow:auto}
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnHamburger" class="hamburger" title="Menu">|||</button>
      <div>
        <h1>The Coach: WRITING</h1>
        <p class="lead">T·∫°o C√¢u Chu·∫©n Band - Ch·∫•m ƒê·ªß 4 Ti√™u Ch√≠</p>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabPractice">Luy·ªán t·∫≠p</button>
      <button class="tab" id="tabManual">T·∫°o th·ªß c√¥ng</button>
      <button class="tab" id="tabGenSent">T·∫°o C√¢u</button>
      <button class="tab" id="tabSpoken">T·∫°o VƒÉn N√≥i</button>
      <button class="tab" id="tabIELTSGen">T·∫°o VƒÉn IELTS</button>
      <button class="tab" id="tabWriting">Writing</button>
      <button class="tab" id="tabAsk">H·ªèi AI</button>
      <button class="tab" id="tabDict">T·ª´ ƒëi·ªÉn</button>
      <button class="tab" id="tabHistory">L·ªãch s·ª≠</button>
      <button class="tab" id="tabSettings">C√†i ƒë·∫∑t</button>
      <button id="toggleTheme" class="themeToggle" title="ƒê·ªïi giao di·ªán">üå§Ô∏è</button>
    </div>
  </header>

  <!-- PRACTICE -->
  <section id="secPractice" class="grid two" style="margin-top:16px">
    <div class="card row">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="badge">B√†i luy·ªán d·ªãch VI ‚Üí EN</span><span id="counter" class="subtle">C√¢u 1/1</span>
      </div>
      <div class="progress"><div id="progbar" style="width:0%"></div></div>
      <div class="sectionTitle">H√£y D·ªãch</div>
      <div id="viBox" class="boxVI mono limit10">‚Äî</div>

      <div class="row">
        <div class="sectionTitle">Nh·∫≠p ƒê√°p √Ån ·ªû ƒê√¢y B·∫°n Nh√©ü•∞</div>
        <textarea id="answer" class="mono" placeholder="G√µ ti·∫øng Anh ·ªü ƒë√¢y..."></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnTranslateNow" class="btn">Xem m·∫´u c√¢u tham kh·∫£o</button>
          <button id="btnSuggest" class="btn">G·ª£i √Ω</button>
          <button id="btnGradeSimple" class="btn primary">Ch·∫•m nhanh 10‚Äì100</button>
          <button id="btnGradeIELTS" class="btn">Ch·∫•m IELTS (4 ti√™u ch√≠)</button>
        </div>
      </div>
      <div id="hint" class="subtle"></div>
    </div>

    <div class="row">
      <div class="card row">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="sectionTitle">G·ª£i √Ω t·ª´ AI Teacher</div>
          <label class="subtle"><input type="checkbox" id="toggleViGloss"> Hi·ªán d·ªãch VI</label>
        </div>
        <div class="kv"><b>Key idea</b><div id="gIdea" class="subtle">‚Äî</div></div>
        <div class="kv"><b>Vocabulary</b><div id="gVocab" class="subtle">‚Äî</div></div>
        <div class="kv"><b>Grammar</b><div id="gGrammar" class="subtle">‚Äî</div></div>
      </div>

      <div class="card row">
        <div class="sectionTitle">K·∫øt qu·∫£</div>
        <div id="gradeHeader" class="subtle">Ch∆∞a ch·∫•m.</div>
        <div id="gradeDiff" class="diff mono scrollBox"></div>
        <div id="gradeBreakdown" class="row"></div>
      </div>
    </div>
  </section>

  <!-- MANUAL -->
  <section id="secManual" class="card row" style="display:none;margin-top:16px">
    <div class="badge">T·∫°o c√¢u/ƒëo·∫°n ti·∫øng Vi·ªát th·ªß c√¥ng ‚Ä¢ Th√™m v√†o Luy·ªán t·∫≠p</div>
    <textarea id="manualVI" class="mono" placeholder="D√°n nhi·ªÅu d√≤ng, m·ªói d√≤ng 1 c√¢u. C√≥ th·ªÉ d√°n ƒëo·∫°n d√†i."></textarea>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="btnUseManual" class="btn primary">Th√™m v√†o Luy·ªán t·∫≠p</button>
      <span id="manualHint" class="subtle"></span>
    </div>
  </section>

  <!-- GEN SENT -->
  <section id="secGenSent" class="card row" style="display:none;margin-top:16px">
    <div class="badge">T·∫°o c√¢u ti·∫øng Vi·ªát theo band (A2/B1/B2/C1) + Ng·ªØ c·∫£nh ‚Ä¢ D√πng ƒë·ªÉ luy·ªán d·ªãch</div>
    <div class="grid" style="grid-template-columns:1.2fr .8fr">
      <div class="row">
        <div class="grid" style="grid-template-columns:repeat(4,1fr);gap:8px">
          <label>Band
            <select id="gsBand" class="select">
              <option value="A2">A2 (c∆° b·∫£n)</option>
              <option value="B1" selected>B1 (trung c·∫•p th·∫•p)</option>
              <option value="B2">B2 (trung c·∫•p cao)</option>
              <option value="C1">C1 (n√¢ng cao)</option>
            </select>
          </label>
          <label>ƒê·ªô d√†i
            <select id="gsLen" class="select">
              <option value="short" selected>Ng·∫Øn (~8‚Äì15 t·ª´)</option>
              <option value="medium">V·ª´a (~12‚Äì20 t·ª´)</option>
            </select>
          </label>
          <label>S·ªë c√¢u
            <input id="gsCount" type="number" min="1" max="30" value="6" class="input">
          </label>
          <label>Ch·ªß ƒë·ªÅ
            <input id="gsTopic" class="input" placeholder="gia ƒë√¨nh, c√¥ng vi·ªác, du l·ªãch...">
          </label>
        </div>
        <label>Ng·ªØ c·∫£nh (tu·ª≥ ch·ªçn)
          <textarea id="gsContext" class="mono" placeholder="V√≠ d·ª•: h·ªôi tho·∫°i ·ªü qu√°n c√† ph√™; ng·ªØ c·∫£nh ƒë·∫∑t ch·ªó kh√°ch s·∫°n; t√¨nh hu·ªëng thuy·∫øt tr√¨nh..."></textarea>
        </label>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnGSGen" class="btn primary">T·∫°o c√¢u (VI)</button>
          <span id="gsHint" class="subtle"></span>
        </div>
      </div>
      <aside class="row">
        <div class="sectionTitle">K·∫øt qu·∫£</div>
        <div id="gsOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
        <div style="display:flex;gap:8px"><button id="btnGSUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button></div>
      </aside>
    </div>
  </section>

  <!-- SPOKEN -->
  <section id="secSpoken" class="card row" style="display:none;margin-top:16px">
    <div class="badge">T·∫°o b√†i <b>vƒÉn n√≥i</b> (ti·∫øng Vi·ªát) ‚Ä¢ Theo Ng·ªØ C·∫£nh</div>
    <div class="grid" style="grid-template-columns:1.2fr .8fr">
      <div class="row">
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
          <label>Ch·ªß ƒë·ªÅ<input id="spTopic" class="input" placeholder="ƒë·ªùi s·ªëng, h·ªçc t·∫≠p, du l·ªãch..."></label>
          <label>ƒê·ªô d√†i
            <select id="spLen" class="select">
              <option value="short">~80‚Äì120 t·ª´</option>
              <option value="medium" selected>~150‚Äì200 t·ª´</option>
              <option value="long">~220‚Äì300 t·ª´</option>
            </select>
          </label>
        </div>
        <label>Ng·ªØ c·∫£nh (tu·ª≥ ch·ªçn)
          <textarea id="spContext" class="mono" placeholder="V√≠ d·ª•: k·ªÉ chuy·ªán v·ªõi b·∫°n; tr√¨nh b√†y tr∆∞·ªõc l·ªõp; chia s·∫ª tr·∫£i nghi·ªám..."></textarea>
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button id="btnSpGen" class="btn primary">T·∫°o vƒÉn n√≥i (VI)</button>
          <button id="btnSpUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button>
          <button id="btnSpTransGrade" class="btn">D·ªãch & Ch·∫•m IELTS</button>
          <span id="spHint" class="subtle"></span>
        </div>
      </div>
      <aside class="row">
        <div class="sectionTitle">K·∫øt qu·∫£</div>
        <div id="spOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
      </aside>
    </div>
  </section>

  <!-- IELTS GEN -->
  <section id="secIELTSGen" class="card row" style="display:none;margin-top:16px">
    <div class="badge">T·∫°o b√†i <b>vƒÉn IELTS</b> (ti·∫øng Vi·ªát): Task 1 / Task 2</div>
    <div class="grid" style="grid-template-columns:1.2fr .8fr">
      <div class="row">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="genEssayType" class="select" style="max-width:220px">
            <option value="task2" selected>Task 2 (Opinion/Argument)</option>
            <option value="task1">Task 1 (M√¥ t·∫£ bi·ªÉu ƒë·ªì)</option>
          </select>
          <select id="genEssayLen" class="select" style="max-width:220px">
            <option value="short">~140 t·ª´</option>
            <option value="medium" selected>~200‚Äì230 t·ª´</option>
            <option value="long">~260‚Äì300 t·ª´</option>
          </select>
          <button id="btnGenEssayVI" class="btn primary">T·∫°o b√†i vƒÉn IELTS (VI)</button>
          <button id="btnIELTSUse" class="btn">Th√™m v√†o Luy·ªán t·∫≠p</button>
          <button id="btnIELTSTransGrade" class="btn">D·ªãch & Ch·∫•m IELTS</button>
          <span id="ieltsGenHint" class="subtle"></span>
        </div>
      </div>
      <aside class="row">
        <div class="sectionTitle">K·∫øt qu·∫£</div>
        <div id="ieltsGenOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
      </aside>
    </div>
  </section>

  <!-- WRITING -->
  <section id="secWriting" class="card row" style="display:none;margin-top:16px">
    <div class="badge">Writing Task ‚Ä¢ Ch·∫•m IELTS b√†i EN & D·ªãch b√†i VI ‚ûú EN (Task1/Task2)</div>
    <div class="grid" style="grid-template-columns:1.2fr .8fr">
      <div class="row">
        <label>ƒê·ªÅ b√†i</label>
        <textarea id="wrPrompt" class="mono" placeholder="Nh·∫≠p ƒë·ªÅ vi·∫øt..."></textarea>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnGenPrompt" class="btn">T·∫°o ƒë·ªÅ b·∫±ng AI</button>
          <select id="wrType" class="select">
            <option value="task2" selected>Task 2 (Opinion/Argument)</option>
            <option value="task1">Task 1 (Graph/Chart)</option>
          </select>
          <span id="wrPromptHint" class="subtle"></span>
        </div>
        <label style="margin-top:10px">B√†i vi·∫øt (EN) ‚Äî d√πng ƒë·ªÉ ch·∫•m</label>
        <textarea id="wrEssay" class="mono" placeholder="Vi·∫øt b√†i b·∫±ng ti·∫øng Anh..."></textarea>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
          <button id="btnGradeEssay" class="btn primary">Ch·∫•m IELTS (4 ti√™u ch√≠)</button>
          <span id="wrHint" class="subtle"></span>
        </div>
      </div>
      <aside class="row">
        <div class="sectionTitle">·∫¢nh bi·ªÉu ƒë·ªì (tu·ª≥ ch·ªçn)</div>
        <div id="chartBox" style="border:1px dashed var(--line);border-radius:12px;padding:10px;display:grid;place-items:center;cursor:pointer;min-height:150px;background:#fbfdff">
          <span class="subtle">Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh (png/jpg)</span>
          <img id="chartImg" alt="" style="max-width:100%;display:none;border-radius:8px">
        </div>
        <input id="chartPicker" type="file" accept="image/*" style="display:none">
      </aside>
    </div>

    <div class="card row" style="margin-top:10px">
      <div class="sectionTitle">D·ªãch b√†i ti·∫øng Vi·ªát ‚ûú English (gi·ªØ phong c√°ch IELTS)</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <select id="trTaskType" class="select" style="max-width:220px">
          <option value="task2" selected>Task 2</option>
          <option value="task1">Task 1</option>
        </select>
        <button id="btnTranslateTask" class="btn">D·ªãch b√†i VI ‚ûú EN</button>
        <button id="btnGradeTranslated" class="btn">Ch·∫•m k·∫øt qu·∫£ d·ªãch</button>
        <span id="trTaskHint" class="subtle"></span>
      </div>
      <textarea id="trTaskInput" class="mono" placeholder="D√°n b√†i ti·∫øng Vi·ªát (Task 1/2) v√†o ƒë√¢y..."></textarea>
      <div class="sectionTitle">K·∫øt qu·∫£ d·ªãch (EN)</div>
      <div id="trTaskOut" class="card mono scrollBox" style="white-space:pre-wrap"></div>
    </div>

    <div class="card row" id="wrResult" style="display:none">
      <div class="sectionTitle">K·∫øt qu·∫£ IELTS</div>
      <div id="wrHead" class="subtle">‚Äî</div>
      <div id="wrDiff" class="diff mono scrollBox"></div>
      <div id="wrBreakdown" class="row"></div>
    </div>
  </section>

  <!-- ASK AI -->
  <section id="secAsk" class="card row" style="display:none;margin-top:16px">
    <div class="badge">H·ªèi AI (gi·∫£i th√≠ch ng·ªØ ph√°p, s·ª≠a c√¢u, v√≠ d·ª• theo ng·ªØ c·∫£nh)</div>
    <div class="chat" id="chatBox"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <input id="askInput" class="input" placeholder="V√≠ d·ª•: Gi·∫£i th√≠ch present perfect vs past simple...">
      <button id="btnAsk" class="btn primary">G·ª≠i</button>
      <span id="askHint" class="subtle"></span>
    </div>
  </section>

  <!-- DICT -->
  <section id="secDict" class="card row" style="display:none;margin-top:16px">
    <div class="badge">T·ª´ ƒëi·ªÉn ng·ªØ c·∫£nh (IPA UK/US + nhi·ªÅu nghƒ©a + v√≠ d·ª•)</div>
    <div class="grid" style="grid-template-columns:1.1fr .9fr">
      <div class="row">
        <label>Tra t·ª´/c·ª•m t·ª´<input id="q" class="input" placeholder="take off, anxiety, run into..."></label>
        <div style="display:flex;gap:8px;align-items:center"><button id="btnLookup" class="btn primary">Tra</button><button id="btnLookupFromVI" class="btn">G·ª£i √Ω d·ªãch c√¢u hi·ªán t·∫°i</button><span id="dictHint" class="subtle"></span></div>
        <div id="dictOut" class="row"></div>
      </div>
      <aside class="row"><div class="sectionTitle">L·ªãch s·ª≠ t·ª´ ƒëi·ªÉn</div><div id="dictHistory" class="subtle">Ch∆∞a c√≥.</div></aside>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="secHistory" class="card row" style="display:none;margin-top:16px">
    <div class="badge">L·ªãch s·ª≠ l√†m b√†i</div>
    <div class="row" style="grid-template-columns:repeat(4,1fr);gap:10px">
      <div class="stat"><span>T·ªïng l∆∞·ª£t</span><b id="hisTotal">0</b></div>
      <div class="stat"><span>ƒêi·ªÉm TB</span><b id="hisAvg">0</b></div>
      <div class="stat"><span>ƒê√∫ng (Simple ‚â•90)</span><b id="hisCorrect">0</b></div>
      <div class="stat"><span>T·ªâ l·ªá ƒë√∫ng</span><b id="hisRate">0%</b></div>
    </div>
    <table class="table" id="hisTable"><thead><tr><th>Th·ªùi gian</th><th>Lo·∫°i</th><th>Input</th><th>ƒêi·ªÉm/Band</th><th>K·∫øt qu·∫£</th></tr></thead><tbody></tbody></table>
  </section>

  <!-- SETTINGS -->
  <section id="secSettings" class="card row" style="display:none;margin-top:16px">
    <div class="badge">C√†i ƒë·∫∑t API</div>
    <div class="grid" style="grid-template-columns:1.2fr .8fr">
      <div class="row"><label>OpenAI API Key<input id="apiKey" class="input" type="password" placeholder="sk-..."></label><div class="subtle">Nh·∫≠p API key v√†o ƒë√¢y.</div></div>
      <div class="row"><label>Model<select id="model" class="select"><option value="gpt-4o-mini" selected>gpt-4o-mini</option><option value="gpt-4o">gpt-4o</option><option value="gpt-4.1-mini">gpt-4.1-mini</option></select></label><label style="margin-top:6px">Endpoint<input id="endpoint" class="input" value="https://api.openai.com/v1/chat/completions"></label></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center"><button id="btnSave" class="btn primary">L∆∞u</button><span id="saveMsg" class="subtle"></span></div>
  </section>
</div>

<!-- FOOTER -->
<div id="footerNav" class="footerNav">
  <div class="wrapNav"><span class="subtle">Ph√≠m t·∫Øt: ‚Üê / ‚Üí</span><div style="display:flex;gap:8px"><button id="btnPrev" class="btn">C√¢u tr∆∞·ªõc</button><button id="btnNext" class="btn primary">C√¢u ti·∫øp theo</button></div></div>
</div>

<!-- PROFILE DRAWER -->
<div id="drawer" class="drawer" aria-label="Menu">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div class="sectionTitle">H·ªì s∆°</div>
    <button id="btnCloseDrawer" class="btn">ƒê√≥ng</button>
  </div>

  <div class="row" style="align-items:center">
    <div style="display:flex;gap:12px;align-items:center">
      <img id="avatar" class="avatar" alt="·∫¢nh ƒë·∫°i di·ªán" src="">
      <div class="row" style="gap:6px">
        <input id="displayName" class="input" placeholder="T√™n hi·ªÉn th·ªã">
        <div class="subtle">Ch√∫c b·∫°n h·ªçc vui v·∫ª</div>
      </div>
    </div>
  </div>
  <div class="row" style="grid-template-columns:repeat(3,1fr)">
    <div class="stat"><span>ƒêi·ªÉm TB</span><b id="pAvg">0</b></div>
    <div class="stat"><span>ƒê√£ l√†m</span><b id="pTotal">0</b></div>
    <div class="stat"><span>T·ªâ l·ªá ƒë√∫ng</span><b id="pRate">0%</b></div>
  </div>
  <div class="row"><button id="btnExportCSV" class="btn">Xu·∫•t CSV</button><button id="btnResetProfile" class="btn">Xo√° l·ªãch s·ª≠</button></div>

  <div class="card row" id="donatePanel" style="margin-top:12px">
    <div class="sectionTitle">Donate</div>
    <div class="kv"><b>T√™n Ch·ªß T√†i Kho·∫£n</b><div id="dnName">‚Äî</div></div>
    <div class="kv"><b>Th√¥ng ƒêi·ªáp</b><div id="dnNote" class="subtle">‚Äî</div></div>
    <div class="row"><img id="dnQR" alt="QR Donate" style="max-width:100%;border-radius:10px;border:1px solid var(--line);box-shadow:var(--soft)"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a id="dnPay" class="btn primary" target="_blank" rel="noopener">Li√™n h·ªá</a>
      <button id="dnCopy" class="btn">Copy link</button>
    </div>
  </div>

  <input id="filePicker" type="file" accept="image/*" style="display:none">
</div>
<div id="backdrop" class="backdrop"></div>

<script>
/* ====== CONSTANTS / STORAGE ====== */
const DONATE_NAME="Ho√†ng xxxxxxxxxxx Tu·∫•n";
const DONATE_NOTE="S·ª± ·ª¶ng H·ªô C·ªßa B·∫°n S·∫Ω Gi√∫p √çch R·∫•t L·ªõn Cho Ch√∫ng T√¥i";
const DONATE_QR_IMG="https://www.facebook.com/share/17KTnVMyMs/?mibextid=wwXIfr";
const DONATE_PAY_URL="https://www.facebook.com/share/17KTnVMyMs/?mibextid=wwXIfr";

const $=s=>document.querySelector(s);
const el=(t,c,h)=>{const x=document.createElement(t);if(c)x.className=c;if(h!=null)x.innerHTML=h;return x;};
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const esc=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const S={items:'ls_items',idx:'ls_idx',attempts:'ls_attempts',api:'ai_key',mdl:'ai_model',ep:'ai_ep',dict:'dict_hist',avatar:'profile_avatar',name:'profile_name',wrp:'wr_prompt',wri:'wr_img'};
const store={
  get items(){try{return JSON.parse(localStorage.getItem(S.items)||'[]')}catch(_){return[]}}, set items(v){localStorage.setItem(S.items,JSON.stringify(v||[]))},
  get idx(){return parseInt(localStorage.getItem(S.idx)||'0',10)||0}, set idx(v){localStorage.setItem(S.idx,String(v|0))},
  get attempts(){try{return JSON.parse(localStorage.getItem(S.attempts)||'[]')}catch(_){return[]}}, set attempts(v){localStorage.setItem(S.attempts,JSON.stringify(v||[]))},
  get key(){return localStorage.getItem(S.api)||''}, set key(v){localStorage.setItem(S.api,v||'')},
  get mdl(){return localStorage.getItem(S.mdl)||'gpt-4o-mini'}, set mdl(v){localStorage.setItem(S.mdl,v||'gpt-4o-mini')},
  get ep(){return localStorage.getItem(S.ep)||'https://api.openai.com/v1/chat/completions'}, set ep(v){localStorage.setItem(S.ep,v||'https://api.openai.com/v1/chat/completions')},
  get dict(){try{return JSON.parse(localStorage.getItem(S.dict)||'[]')}catch(_){return[]}}, set dict(v){localStorage.setItem(S.dict,JSON.stringify(v||[]))},
  get avatar(){return localStorage.getItem(S.avatar)||''}, set avatar(v){localStorage.setItem(S.avatar,v||'')},
  get name(){return localStorage.getItem(S.name)||''}, set name(v){localStorage.setItem(S.name,v||'')},
  get wrp(){return localStorage.getItem(S.wrp)||''}, set wrp(v){localStorage.setItem(S.wrp,v||'')},
  get wri(){return localStorage.getItem(S.wri)||''}, set wri(v){localStorage.setItem(S.wri,v||'')}
};

/* ====== THEME ====== */
const root=document.documentElement;const prefersDark=matchMedia('(prefers-color-scheme: dark)').matches;
if(localStorage.getItem('theme')==='dark'||(!localStorage.getItem('theme')&&prefersDark)){root.classList.add('dark');$('#toggleTheme').textContent='üåô';}
$('#toggleTheme').onclick=()=>{root.classList.toggle('dark');const d=root.classList.contains('dark');localStorage.setItem('theme',d?'dark':'light');$('#toggleTheme').textContent=d?'üåô':'üå§Ô∏è';};

/* ====== FOOTER HEIGHT AUTO (fix che n·ªôi dung/n√∫t) ====== */
function applyFooterPadding(){
  const f=$('#footerNav'); if(!f) return;
  const h=f.offsetHeight||78;
  root.style.setProperty('--footer-h',h+'px');
}
new ResizeObserver(applyFooterPadding).observe(document.body);
window.addEventListener('load',applyFooterPadding);
window.addEventListener('resize',applyFooterPadding);
applyFooterPadding();

/* ====== TABS ====== */
const tabs=[['#tabPractice','#secPractice'],['#tabManual','#secManual'],['#tabGenSent','#secGenSent'],['#tabSpoken','#secSpoken'],['#tabIELTSGen','#secIELTSGen'],['#tabWriting','#secWriting'],['#tabAsk','#secAsk'],['#tabDict','#secDict'],['#tabHistory','#secHistory'],['#tabSettings','#secSettings']];
tabs.forEach(([b,s])=>$(b).onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('section.card,section.grid').forEach(x=>x.style.display='none');$(b).classList.add('active');$(s).style.display='grid'; if(s==='#secHistory') renderHistory(); if(s==='#secAsk') setTimeout(()=>$('#askInput').focus(),50);});

/* ====== PRACTICE DATA ====== */
let items=store.items.length?store.items:[
  "Ch√∫ng t√¥i ƒëang xem phim ·ªü r·∫°p chi·∫øu phim, phim r·∫•t hay.",
  "H·ªç ƒëang x√¢y m·ªôt ng√¥i nh√† m·ªõi, n√≥ s·∫Ω r·∫•t l·ªõn.",
  "T√¥i ƒëang h·ªçc l√°i xe, t√¥i r·∫•t lo l·∫Øng."
];
let idx=clamp(store.idx,0,items.length-1);
function renderPractice(){
  const total=items.length||1; idx=clamp(idx,0,total-1);
  $('#viBox').textContent=items[idx]||'‚Äî'; $('#answer').value='';
  $('#gIdea').textContent='‚Äî'; $('#gVocab').textContent='‚Äî'; $('#gGrammar').textContent='‚Äî';
  $('#gradeHeader').textContent='Ch∆∞a ch·∫•m.'; $('#gradeDiff').innerHTML=''; $('#gradeBreakdown').innerHTML='';
  $('#counter').textContent=`C√¢u ${idx+1}/${total}`; $('#progbar').style.width=`${Math.round(((idx+1)/total)*100)}%`;
  store.items=items; store.idx=idx;
}
renderPractice();
$('#btnPrev').onclick=()=>{idx=clamp(idx-1,0,items.length-1);renderPractice();};
$('#btnNext').onclick=()=>{idx=clamp(idx+1,0,items.length-1);renderPractice();};
window.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')$('#btnPrev').click(); if(e.key==='ArrowRight')$('#btnNext').click();});

/* ====== UTIL / OPENAI ====== */
function setBusy(on){document.querySelectorAll('button').forEach(b=>b.disabled=!!on);}
async function callOpenAI(sys,usr,max_tokens=900){
  if(!store.key) throw new Error('Ch∆∞a c√≥ API key (tab C√†i ƒë·∫∑t).');
  const r=await fetch(store.ep,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+store.key},body:JSON.stringify({model:store.mdl,temperature:0.2,max_tokens,messages:[{role:'system',content:sys},{role:'user',content:usr}]})});
  if(!r.ok){const t=await r.text();throw new Error('API l·ªói '+r.status+' ‚Äî '+t);}
  const d=await r.json(); return d.choices?.[0]?.message?.content||'';
}
const parseJSON=t=>{try{return JSON.parse(t.trim().replace(/^```json|```$/g,''))}catch(_){return null}};

/* ====== DIFF G·ªåN (SIMPLE) ====== */
function tokenize(s){return (s||'').replace(/\s+/g,' ').trim().split(/(\s+|[.,!?;:;()'"-])/).filter(x=>x!=='');}
function diffCompact(a,b,maxSameRun=28){
  const A=tokenize(a), B=tokenize(b);
  const m=A.length,n=B.length;const dp=[...Array(m+1)].map(()=>Array(n+1).fill(0));
  for(let i=m-1;i>=0;i--)for(let j=n-1;j>=0;j--)dp[i][j]=A[i]===B[j]?dp[i+1][j+1]+1:Math.max(dp[i+1][j],dp[i][j+1]);
  let i=0,j=0,buf=[],sameRun=0;
  const flushSame=()=>{if(sameRun>0){ if(sameRun>maxSameRun) buf.push('<span class="ellipsis"> ‚Ä¶ </span>'); else for(let k=0;k<sameRun;k++) buf.push(esc(A[i-sameRun+k])); sameRun=0;}};
  while(i<m&&j<n){
    if(A[i]===B[j]){sameRun++;i++;j++;if(sameRun>maxSameRun+10){flushSame();}}
    else if(dp[i+1][j]>=dp[i][j+1]){flushSame();buf.push(`<span class="del">${esc(A[i])}</span>`);i++;}
    else{flushSame();buf.push(`<span class="ins">${esc(B[j])}</span>`);j++;}
  }
  while(i<m){flushSame();buf.push(`<span class="del">${esc(A[i++])}</span>`);}
  while(j<n){flushSame();buf.push(`<span class="ins">${esc(B[j++])}</span>`);}
  flushSame(); return buf.join('');
}

/* ====== DIFF WRITING (3 m√†u, kh√¥ng g·∫°ch) ====== */
function diffWriting(userText, revisionText, severity='near'){
  const A=tokenize(userText), B=tokenize(revisionText);
  const m=A.length,n=B.length;
  const dp=[...Array(m+1)].map(()=>Array(n+1).fill(0));
  for(let i=m-1;i>=0;i--) for(let j=n-1;j>=0;j--) dp[i][j]=(A[i]===B[j])?dp[i+1][j+1]+1:Math.max(dp[i+1][j],dp[i][j+1]);
  let i=0,j=0,buf=[];
  const mark=t => (t.trim()==='') ? esc(t) : `<span class="${severity}">${esc(t)}</span>`;
  while(i<m && j<n){
    if(A[i]===B[j]){ buf.push(esc(B[j])); i++; j++; }
    else if(dp[i+1][j]>=dp[i][j+1]){ i++; } // b·ªè token c≈©
    else{ buf.push(mark(B[j])); j++; }      // token m·ªõi/s·ª≠a -> t√¥ m√†u
  }
  while(j<n){ buf.push(mark(B[j++])); }
  return buf.join('');
}

function similarity(a,b){
  const tok=s=>new Set((s||'').toLowerCase().match(/[a-z']+/g)||[]);
  const A=tok(a),B=tok(b); let inter=0; A.forEach(x=>{if(B.has(x)) inter++;});
  const uni=A.size+B.size-inter||1; return inter/uni;
}

/* ====== PROMPTS / SCORING ====== */
const SIMPLE_PROMPT=`You are a VERY STRICT English checker for Vietnamese‚ÜíEnglish translation.
Return STRICT JSON ONLY: {"score":10-100,"explain_vi":"...","correction":"..."}
Rules: 100 ONLY if fully correct in meaning, grammar, capitalization, spelling, punctuation; penalize ALL-CAPS/missing period.`;
const SIMPLE_PROMPT_LONG=`You are a STRICT English checker for a segment of a Vietnamese‚ÜíEnglish translation.
Given the FULL Vietnamese source (context) and ONE English segment, judge ONLY that segment against the overall meaning.
Return STRICT JSON ONLY: {"score":10-100,"explain_vi":"ng·∫Øn g·ªçn","correction":"..."}.
Be concise in explain_vi. Penalize grammar/word choice/punctuation errors.`;

const IELTS_PROMPT=`You are a VERY STRICT IELTS-style grader for short English output from a Vietnamese source.
Return STRICT JSON ONLY:{
 "overall_score":0-100,"criteria":{"grammar":{"score":0-25,"explain_vi":"...","suggest":"..."},
 "vocabulary":{"score":0-25,"explain_vi":"...","suggest":"..."},
 "coherence":{"score":0-25,"explain_vi":"...","suggest":"..."},
 "task":{"score":0-25,"explain_vi":"...","suggest":"..."} },
 "errors":[{"type":"tense|sva|articles|prepositions|word choice|collocation|punctuation|spelling|structure","from":"‚Ä¶","to":"‚Ä¶","explain_vi":"‚Ä¶"}],
 "suggest_revision":"..."
}
STRICT: Do NOT award high scores for simplistic one-clause outputs.`;

const IELTS_WR_SYS=`You are a STRICT IELTS Writing examiner for Task 1/Task 2.
Return STRICT JSON ONLY:{
 "overall_score":0-100,
 "criteria":{"grammar":{"score":0-25,"explain_vi":"...","suggest":"..."},
             "vocabulary":{"score":0-25,"explain_vi":"...","suggest":"..."},
             "coherence":{"score":0-25,"explain_vi":"...","suggest":"..."},
             "task":{"score":0-25,"explain_vi":"...","suggest":"..."}},
 "errors":[{"type":"tense|sva|articles|prepositions|word choice|collocation|punctuation|spelling|structure|cohesion","from":"‚Ä¶","to":"‚Ä¶","explain_vi":"‚Ä¶"}],
 "suggest_revision":"..."
}
Calibration:
- Do NOT give Band 7.0+ unless there is clear paragraphing, varied complex structures, logical development, precise lexis.
- Very short/simple texts ‚Üí Band 5.0‚Äì6.0 max.
- Band 8.0 requires rare errors and strong range + precision.`;

function bandFromScore(s){if(s>=95)return 9.0;if(s>=85)return 8.0;if(s>=75)return 7.0;if(s>=65)return 6.0;if(s>=55)return 5.0;if(s>=45)return 4.0;if(s>=35)return 3.0;if(s>=25)return 2.0;return 1.0;}
function metrics(text){
  const t=(text||'').replace(/\s+/g,' ').trim();
  const words=(t.match(/[A-Za-z]+(?:'[A-Za-z]+)?/g)||[]);
  const wordCount=words.length;
  const types=new Set(words.map(w=>w.toLowerCase())).size;
  const ttr=wordCount?types/wordCount:0;
  const sentences=(t.split(/[.!?]+/).map(s=>s.trim()).filter(Boolean));
  const sentCount=sentences.length||0;
  const avgLen=wordCount&&sentCount?wordCount/sentCount:wordCount;
  const clauseMarkers=(t.match(/\b(and|but|because|although|however|which|that|who|while|whereas|moreover|therefore|in addition|on the other hand)\b/gi)||[]).length;
  const linking=(t.match(/\b(firstly|secondly|finally|overall|in general|to conclude|in conclusion|as a result|for example|for instance)\b/gi)||[]).length;
  return {wordCount,ttr,sentCount,avgLen,clauseMarkers,linking};
}
function capByMode(text,mode){
  const m=metrics(text); let cap=9.0;
  if(m.wordCount<10) cap=4.5;
  else if(m.sentCount<=1 && m.wordCount<20) cap=Math.min(cap,5.0);
  if(m.clauseMarkers<1) cap=Math.min(cap,6.0);
  if(m.avgLen<10) cap=Math.min(cap,6.0);
  if(m.ttr<0.35) cap=Math.min(cap,6.5);
  if(m.ttr<0.28) cap=Math.min(cap,6.0);
  if(mode==='task2'){ if(m.wordCount<180) cap=Math.min(cap,6.0); else if(m.wordCount<220) cap=Math.min(cap,7.0); }
  if(mode==='task1'){ if(m.wordCount<150) cap=Math.min(cap,6.5); if(!/\boverall|in general\b/i.test(text)) cap=Math.min(cap,6.5); }
  if(mode==='spoken'){ if(m.wordCount<120||m.sentCount<3) cap=Math.min(cap,6.0); }
  return {cap,m};
}
function showGradingResult(userText, js, headEl, diffEl, breakdownEl, label, mode){
  const baseBand=bandFromScore(js.overall_score);
  const {cap,m}=capByMode(userText,mode||null);
  let band=Math.min(baseBand,cap);
  let adjScore=js.overall_score;
  if(baseBand>band){adjScore=Math.max(0,Math.round(js.overall_score*(band/baseBand)));}

  const sim=similarity(userText,js.suggest_revision||'');
  headEl.innerHTML=`<b>${label}: ${adjScore} ‚Äî Band ${band.toFixed(1)}</b> <span class="subtle">(${m.wordCount}w, ${m.sentCount}s, TTR ${(m.ttr||0).toFixed(2)})</span>${sim>=0.92?' ‚Ä¢ √çt ch·ªânh':''}`;
  const finalRev=(sim>=0.92)?userText:(js.suggest_revision||userText);

  const isWriting = (mode==='spoken'||mode==='task1'||mode==='task2');
  diffEl.className = 'diff mono scrollBox ' + (isWriting ? 'writing' : 'simple');

  if(isWriting){
    const sev = (band>=7 ? 'good' : (band>=5 ? 'near' : 'bad'));
    diffEl.innerHTML = diffWriting(userText, finalRev, sev);
  }else{
    diffEl.innerHTML = diffCompact(userText, finalRev);
  }

  const c=js.criteria||{};
  breakdownEl.innerHTML=`
    <div class="card row"><b>Grammar</b>: ${c.grammar?.score??0}/25<div class="subtle">${esc(c.grammar?.explain_vi||'')}</div><div class="mono">${esc(c.grammar?.suggest||'')}</div></div>
    <div class="card row"><b>Vocabulary</b>: ${c.vocabulary?.score??0}/25<div class="subtle">${esc(c.vocabulary?.explain_vi||'')}</div><div class="mono">${esc(c.vocabulary?.suggest||'')}</div></div>
    <div class="card row"><b>Coherence</b>: ${c.coherence?.score??0}/25<div class="subtle">${esc(c.coherence?.explain_vi||'')}</div><div class="mono">${esc(c.coherence?.suggest||'')}</div></div>
    <div class="card row"><b>Task/Complexity</b>: ${c.task?.score??0}/25<div class="subtle">${esc(c.task?.explain_vi||'')}</div><div class="mono">${esc(c.task?.suggest||'')}</div></div>
    ${Array.isArray(js.errors)&&js.errors.length?`<div class="card row"><b>L·ªói</b><div>${js.errors.map(e=>`<span class="errtag mono">[${esc(e.type)}] "${esc(e.from)}" ‚Üí "${esc(e.to)}" ‚Äî ${esc(e.explain_vi)}</span>`).join('')}</div></div>`:''}
  `;
}

/* ====== CH·∫§M 10‚Äì100 TH√îNG MINH (b√†i d√†i) ====== */
function splitBySentences(text){
  const s=(text||'').trim().replace(/\s+/g,' ');
  return s.length? s.split(/(?<=[.!?])\s+(?=[A-Z0-9])/).filter(Boolean):[];
}
function groupChunks(sents,maxWords=60,maxSents=3){
  const groups=[]; let cur=[]; let wc=0;
  for(const s of sents){
    const w=(s.match(/[A-Za-z]+/g)||[]).length;
    if(cur.length && (wc+w>maxWords || cur.length>=maxSents)){ groups.push(cur.join(' ')); cur=[s]; wc=w; }
    else { cur.push(s); wc+=w; }
  }
  if(cur.length) groups.push(cur.join(' '));
  return groups;
}
async function gradeSimpleSmart(vi,en){
  const words=(en.match(/[A-Za-z]+/g)||[]).length;
  if(words<=40){
    const r=parseJSON(await callOpenAI(SIMPLE_PROMPT,`VI: ${vi}\nEN: ${en}`,500));
    if(!r||typeof r.score!=='number'||!r.correction) throw 'K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.';
    return {score:r.score, explain:r.explain_vi||'', corr:r.correction};
  }
  const sents=splitBySentences(en);
  const chunks=groupChunks(sents,80,3).slice(0,6);
  let totalScore=0,totalLen=0,allExplain=[],corrParts=[];
  for(const ch of chunks){
    const len=(ch.match(/[A-Za-z]+/g)||[]).length||1;
    const usr=`FULL_VI:\n${vi}\n\nEN_CHUNK:\n${ch}`;
    const r=parseJSON(await callOpenAI(SIMPLE_PROMPT_LONG,usr,450));
    if(!r||typeof r.score!=='number'||!r.correction){continue;}
    totalScore+=r.score*len; totalLen+=len;
    allExplain.push(r.explain_vi||'');
    corrParts.push(r.correction.trim());
  }
  if(!totalLen) throw 'Kh√¥ng ch·∫•m ƒë∆∞·ª£c.';
  const avgScore=Math.round(totalScore/totalLen);
  const corr=corrParts.join(' ').replace(/\s+/g,' ').trim();
  const explain=allExplain.filter(Boolean).slice(0,4).join(' | ');
  return {score:avgScore, explain, corr};
}

/* ====== BUTTONS: ADD / MANUAL ====== */
$('#btnUseManual').onclick=()=>{
  const raw=($('#manualVI').value||'').trim();
  if(!raw){$('#manualHint').textContent='B·∫°n ch∆∞a nh·∫≠p n·ªôi dung.';return;}
  const lines=raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  if(!lines.length){$('#manualHint').textContent='Kh√¥ng c√≥ c√¢u h·ª£p l·ªá.';return;}
  items=items.concat(lines); store.items=items; idx=items.length-lines.length;
  $('#manualHint').textContent=`ƒê√£ th√™m ${lines.length} c√¢u/ƒëo·∫°n v√†o Luy·ªán t·∫≠p.`;
  setTimeout(()=>{$('#manualHint').textContent=''; $('#tabPractice').click(); renderPractice();},900);
};

/* ====== AI TEACHER / TRANSLATE / GRADE ====== */
$('#btnSuggest').onclick=async()=>{
  const vi=items[idx]; const sys=`B·∫°n l√† AI Teacher. Tr·∫£ JSON {"idea_en":"","idea_vi":"","vocab_en":[""],"vocab_vi":[""],"grammar_en":[""],"grammar_vi":[""]}`;
  try{setBusy(true);$('#hint').textContent='ƒêang g·ª£i √Ω...'; const js=parseJSON(await callOpenAI(sys,'Vietnamese: '+vi,450));
    if(!js) throw 'K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.'; const showVI=$('#toggleViGloss').checked;
    $('#gIdea').textContent=(js.idea_en||'‚Äî')+(showVI&&js.idea_vi?` ‚Äî ${js.idea_vi}`:'');
    $('#gVocab').textContent=(js.vocab_en||[]).join(', ')+(showVI&&js.vocab_vi?.length?` ‚Äî ${js.vocab_vi.join(', ')}`:'');
    $('#gGrammar').textContent=(js.grammar_en||[]).join('; ')+(showVI&&js.grammar_vi?.length?` ‚Äî ${js.grammar_vi.join('; ')}`:'');
    $('#hint').textContent='';
  }catch(e){$('#hint').textContent=e+'';}finally{setBusy(false);}
};
$('#btnTranslateNow').onclick=async()=>{
  const vi=items[idx]; const sys=`Translate Vietnamese to natural, context-aware English. Return plain English only.`;
  try{setBusy(true);$('#hint').textContent='ƒêang d·ªãch...'; const en=await callOpenAI(sys,vi,250); $('#answer').value=en.trim(); $('#hint').textContent='ƒê√£ ch√®n b·∫£n d·ªãch tham kh·∫£o.'; setTimeout(()=>$('#hint').textContent='',1200);}catch(e){$('#hint').textContent='L·ªói: '+e;}finally{setBusy(false);}
};
$('#btnGradeSimple').onclick=async()=>{
  const vi=items[idx], en=($('#answer').value||'').trim(); if(!en){$('#hint').textContent='B·∫°n ch∆∞a nh·∫≠p b·∫£n d·ªãch.';return;}
  try{
    setBusy(true);$('#hint').textContent='ƒêang ch·∫•m (10‚Äì100)...';
    const r=await gradeSimpleSmart(vi,en);
    $('#gradeHeader').innerHTML=`<b>ƒêi·ªÉm (Simple): ${Math.round(r.score)}</b> ‚Äî ${esc(r.explain||'')}`;
    $('#gradeDiff').innerHTML=diffCompact(en,r.corr);
    $('#gradeBreakdown').innerHTML='';
    $('#hint').textContent='';
    addHistory({type:'simple',input:vi,score:r.score,band:null,ok:r.score>=90});
  }catch(e){$('#gradeHeader').textContent='L·ªói: '+e; $('#gradeDiff').innerHTML=''; $('#gradeBreakdown').innerHTML='';}finally{setBusy(false);}
};
$('#btnGradeIELTS').onclick=async()=>{
  const vi=items[idx], en=($('#answer').value||'').trim(); if(!en){$('#hint').textContent='B·∫°n ch∆∞a nh·∫≠p b·∫£n d·ªãch.';return;}
  try{setBusy(true);$('#hint').textContent='ƒêang ch·∫•m IELTS...'; const r=parseJSON(await callOpenAI(IELTS_PROMPT,`C√¢u g·ªëc (VI): ${vi}\nB√†i l√†m (EN): ${en}`,900));
    if(!r||!r.criteria||typeof r.overall_score!=='number') throw 'K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.';
    showGradingResult(en,r,$('#gradeHeader'),$('#gradeDiff'),$('#gradeBreakdown'),'IELTS Overall','spoken');
    addHistory({type:'ielts',input:vi,score:r.overall_score,band:bandFromScore(r.overall_score),ok:false});
    $('#hint').textContent='';
  }catch(e){$('#gradeHeader').textContent='L·ªói: '+e; $('#gradeDiff').innerHTML=''; $('#gradeBreakdown').innerHTML='';}finally{setBusy(false);}
};

/* ====== GEN SENTENCES ====== */
$('#btnGSGen').onclick=async()=>{
  const band=$('#gsBand').value, len=$('#gsLen').value, n=clamp(parseInt($('#gsCount').value||'6',10)||6,1,30), topic=$('#gsTopic').value.trim()||'chung', ctx=$('#gsContext').value.trim();
  const lengthHint = len==='short' ? '~8‚Äì15' : '~12‚Äì20';
  const sys=`Sinh c√¢u TI·∫æNG VI·ªÜT theo m·ª©c CEFR, d√πng c·∫•u tr√∫c ph√π h·ª£p band, r√µ nghƒ©a, t·ª± nhi√™n. Tr·∫£ JSON {"sentences":["..."]}. Nghi√™m c·∫•m l·∫´n ti·∫øng Anh.`;
  const usr=`Band: ${band}\nS·ªë c√¢u: ${n}\nƒê·ªô d√†i c√¢u: ${lengthHint} t·ª´\nCh·ªß ƒë·ªÅ: ${topic}\nNg·ªØ c·∫£nh: ${ctx||'(tr·ªëng)'}\nY√™u c·∫ßu: ƒëa d·∫°ng c·∫•u tr√∫c, kh√¥ng qu√° kh√≥ so v·ªõi ${band}, m·ªói c√¢u 1 d√≤ng.`;
  try{setBusy(true);$('#gsHint').textContent='ƒêang t·∫°o c√¢u...'; const js=parseJSON(await callOpenAI(sys,usr,600));
    if(!js?.sentences?.length) throw 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c danh s√°ch.'; $('#gsOut').textContent=js.sentences.join('\n'); $('#gsHint').textContent='ƒê√£ t·∫°o.'; setTimeout(()=>$('#gsHint').textContent='',1200);
  }catch(e){$('#gsOut').textContent='L·ªói: '+e; $('#gsHint').textContent='';}finally{setBusy(false);}
};
$('#btnGSUse').onclick=()=>{const t=$('#gsOut').textContent.trim(); if(!t)return; const arr=t.split(/\n+/).map(s=>s.trim()).filter(Boolean); if(!arr.length)return; items=items.concat(arr); store.items=items; idx=items.length-arr.length; renderPractice(); $('#tabPractice').click(); };

/* ====== SPOKEN GEN / ADD / GRADE ====== */
$('#btnSpGen').onclick=async()=>{
  const topic=$('#spTopic').value.trim()||'ƒë·ªùi s·ªëng', len=$('#spLen').value, words=len==='short'?110:(len==='long'?260:180), ctx=$('#spContext').value.trim();
  const sys=`Sinh b√†i VƒÇN TI·∫æNG VI·ªÜT phong c√°ch VƒÇN N√ìI, t·ª± nhi√™n, m·∫°ch l·∫°c, ~${words} t·ª´. Tr·∫£ JSON {"spoken_vi":"..."} (plain text).`;
  const usr=`Ch·ªß ƒë·ªÅ: ${topic}\nNg·ªØ c·∫£nh: ${ctx||'(tr·ªëng)'}\nƒêƒÉng k√Ω: th√¢n thi·ªán, g·∫ßn g≈©i, m·∫°ch l·∫°c.`;
  try{setBusy(true);$('#spHint').textContent='ƒêang t·∫°o vƒÉn n√≥i...'; const js=parseJSON(await callOpenAI(sys,usr,800));
    if(!js?.spoken_vi) throw 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c b√†i vƒÉn.'; $('#spOut').textContent=js.spoken_vi.trim(); $('#spHint').textContent='ƒê√£ t·∫°o.'; setTimeout(()=>$('#spHint').textContent='',1000);
  }catch(e){$('#spOut').textContent='L·ªói: '+e; $('#spHint').textContent='';}finally{setBusy(false);}
};
$('#btnSpUse').onclick=()=>{const t=$('#spOut').textContent.trim(); if(!t){$('#spHint').textContent='Ch∆∞a c√≥ n·ªôi dung.';return;} items=items.concat([t]); store.items=items; idx=items.length-1; $('#spHint').textContent='ƒê√£ th√™m v√†o Luy·ªán t·∫≠p.'; setTimeout(()=>{$('#spHint').textContent=''; $('#tabPractice').click(); renderPractice();},800);};
$('#btnSpTransGrade').onclick=async()=>{
  const vi=$('#spOut').textContent.trim(); if(!vi){$('#spHint').textContent='Ch∆∞a c√≥ vƒÉn n√≥i ƒë·ªÉ ch·∫•m.';return;}
  try{
    setBusy(true);$('#spHint').textContent='ƒêang d·ªãch & ch·∫•m...';
    const en=await callOpenAI('Translate Vietnamese to natural English suitable for general essay; keep paragraphs. Return plain English only.',vi,1200);
    const r=parseJSON(await callOpenAI(IELTS_WR_SYS,`PROMPT:\n[SPOKEN]\n\nESSAY:\n${en}`,1200));
    if(!r||!r.criteria) throw 'Kh√¥ng ch·∫•m ƒë∆∞·ª£c.';
    $('#tabWriting').click(); $('#wrEssay').value=en.trim();
    showGradingResult(en,r,$('#wrHead'),$('#wrDiff'),$('#wrBreakdown'),'IELTS Overall (Spoken‚ÜíEN)','spoken');
    $('#wrResult').style.display='grid';
    $('#spHint').textContent='';
  }catch(e){$('#spHint').textContent='L·ªói: '+e;}finally{setBusy(false);}
};

/* ====== IELTS GEN / ADD / GRADE ====== */
$('#btnGenEssayVI').onclick=async()=>{
  const kind=$('#genEssayType').value, len=$('#genEssayLen').value, words=(len==='short'?140:(len==='long'?280:210));
  const sys=`Sinh b√†i VƒÇN TI·∫æNG VI·ªÜT theo d·∫°ng IELTS ${kind==='task1'?'Task 1 (m√¥ t·∫£ bi·ªÉu ƒë·ªì/so s√°nh s·ªë li·ªáu)':'Task 2 (n√™u quan ƒëi·ªÉm/argument)'} ~${words} t·ª´, m·∫°ch l·∫°c. Tr·∫£ JSON {"essay_vi":"..."}`;
  try{setBusy(true);$('#ieltsGenHint').textContent='ƒêang t·∫°o b√†i vƒÉn VI...'; const js=parseJSON(await callOpenAI(sys,'',900));
    if(!js?.essay_vi) throw 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c b√†i vƒÉn.'; $('#ieltsGenOut').textContent=js.essay_vi.trim(); $('#ieltsGenHint').textContent='ƒê√£ t·∫°o.'; setTimeout(()=>$('#ieltsGenHint').textContent='',1000);
  }catch(e){$('#ieltsGenOut').textContent='L·ªói: '+e; $('#ieltsGenHint').textContent='';}finally{setBusy(false);}
};
$('#btnIELTSUse').onclick=()=>{const t=$('#ieltsGenOut').textContent.trim(); if(!t){$('#ieltsGenHint').textContent='Ch∆∞a c√≥ n·ªôi dung.';return;} items=items.concat([t]); store.items=items; idx=items.length-1; $('#ieltsGenHint').textContent='ƒê√£ th√™m v√†o Luy·ªán t·∫≠p.'; setTimeout(()=>{$('#ieltsGenHint').textContent=''; $('#tabPractice').click(); renderPractice();},800);};
$('#btnIELTSTransGrade').onclick=async()=>{
  const vi=$('#ieltsGenOut').textContent.trim(); if(!vi){$('#ieltsGenHint').textContent='Ch∆∞a c√≥ b√†i ƒë·ªÉ ch·∫•m.';return;}
  const kind=$('#genEssayType').value;
  try{
    setBusy(true);$('#ieltsGenHint').textContent='ƒêang d·ªãch & ch·∫•m...';
    const sysTr=kind==='task1'?'Translate to English in IELTS Task 1 style: overview + key features; objective tone; keep paragraphs.':'Translate to English in IELTS Task 2 argumentative style: clear thesis; academic register; keep paragraphs.';
    const en=await callOpenAI(sysTr,vi,1200);
    const r=parseJSON(await callOpenAI(IELTS_WR_SYS,`PROMPT:\n[${kind.toUpperCase()}]\n\nESSAY:\n${en}`,1200));
    if(!r||!r.criteria) throw 'Kh√¥ng ch·∫•m ƒë∆∞·ª£c.';
    $('#tabWriting').click(); $('#wrEssay').value=en.trim();
    showGradingResult(en,r,$('#wrHead'),$('#wrDiff'),$('#wrBreakdown'),`IELTS Overall (${kind.toUpperCase()} VI‚ÜíEN)`,kind==='task1'?'task1':'task2');
    $('#wrResult').style.display='grid';
    $('#ieltsGenHint').textContent='';
  }catch(e){$('#ieltsGenHint').textContent='L·ªói: '+e;}finally{setBusy(false);}
};

/* ====== WRITING TAB ====== */
$('#wrPrompt').value=store.wrp||'';
if(store.wri){ const img=$('#chartImg'); img.src=store.wri; img.style.display='block'; $('#chartBox').querySelector('span')?.remove(); }
$('#chartBox').onclick=()=>$('#chartPicker').click();
$('#chartPicker').onchange=(e)=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{const img=$('#chartImg'); img.src=r.result; img.style.display='block'; store.wri=r.result; $('#chartBox').querySelector('span')?.remove();}; r.readAsDataURL(f);};
$('#btnGenPrompt').onclick=async()=>{
  const type=$('#wrType').value; const sys=`B·∫°n l√† ng∆∞·ªùi ra ƒë·ªÅ Writing IELTS. Tr·∫£ JSON {"prompt":"...","hints":["...","...","..."]}`;
  const usr= type==='task1' ? 'Sinh 1 ƒë·ªÅ Task 1 m√¥ t·∫£ bi·ªÉu ƒë·ªì (kh√¥ng c·∫ßn ·∫£nh), k√®m 3 g·ª£i √Ω d√†n √Ω.' : 'Sinh 1 ƒë·ªÅ Task 2 (opinion/argument), k√®m 3 g·ª£i √Ω l·∫≠p lu·∫≠n.';
  try{setBusy(true);$('#wrPromptHint').textContent='ƒêang t·∫°o ƒë·ªÅ...'; const js=parseJSON(await callOpenAI(sys,usr,450));
    if(!js||!js.prompt) throw 'K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.'; $('#wrPrompt').value=js.prompt+(Array.isArray(js.hints)?('\n\nG·ª£i √Ω:\n- '+js.hints.join('\n- ')):''); store.wrp=$('#wrPrompt').value; $('#wrPromptHint').textContent='ƒê√£ t·∫°o ƒë·ªÅ.'; setTimeout(()=>$('#wrPromptHint').textContent='',1000);
  }catch(e){$('#wrPromptHint').textContent='L·ªói: '+e;}finally{setBusy(false);}
};
$('#btnGradeEssay').onclick=async()=>{
  const prompt=$('#wrPrompt').value.trim(), essay=$('#wrEssay').value.trim(); if(!essay){$('#wrHint').textContent='B·∫°n ch∆∞a nh·∫≠p b√†i vi·∫øt.';return;}
  const mode=$('#wrType').value==='task1'?'task1':'task2';
  try{
    setBusy(true);$('#wrHint').textContent='ƒêang ch·∫•m IELTS...';
    const js=parseJSON(await callOpenAI(IELTS_WR_SYS,`PROMPT:\n${prompt||'(no prompt)'}\n\nESSAY:\n${essay}`,1200));
    if(!js||!js.criteria) throw 'K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.';
    showGradingResult(essay,js,$('#wrHead'),$('#wrDiff'),$('#wrBreakdown'),'IELTS Overall',mode);
    $('#wrResult').style.display='grid'; $('#wrHint').textContent='';
    addHistory({type:'writing',input:(prompt||'‚Äî').slice(0,80),score:js.overall_score,band:bandFromScore(js.overall_score),ok:false});
  }catch(e){$('#wrHead').textContent='L·ªói: '+e; $('#wrDiff').innerHTML=''; $('#wrBreakdown').innerHTML=''; $('#wrResult').style.display='grid';}finally{setBusy(false);}
};
$('#btnTranslateTask').onclick=async()=>{
  const vi=$('#trTaskInput').value.trim(); if(!vi){$('#trTaskHint').textContent='H√£y d√°n b√†i ti·∫øng Vi·ªát.';return;}
  const kind=$('#trTaskType').value; const sys= kind==='task1'?`Translate to English in IELTS Task 1 style: overview + key features; objective tone; keep paragraphs.`:`Translate to English in IELTS Task 2 argumentative style: clear thesis; academic register; keep paragraphs.`;
  try{setBusy(true);$('#trTaskHint').textContent='ƒêang d·ªãch...'; const out=await callOpenAI(sys,vi,1200); $('#trTaskOut').textContent=out.trim(); $('#trTaskHint').textContent='';}catch(e){$('#trTaskOut').textContent='L·ªói: '+e; $('#trTaskHint').textContent='';}finally{setBusy(false);}
};
$('#btnGradeTranslated').onclick=async()=>{
  const en=$('#trTaskOut').textContent.trim(); if(!en){$('#trTaskHint').textContent='Ch∆∞a c√≥ b·∫£n d·ªãch EN ƒë·ªÉ ch·∫•m.';return;}
  const mode=$('#trTaskType').value==='task1'?'task1':'task2';
  try{
    setBusy(true);$('#trTaskHint').textContent='ƒêang ch·∫•m...';
    const js=parseJSON(await callOpenAI(IELTS_WR_SYS,`PROMPT:\n[${mode.toUpperCase()}]\n\nESSAY:\n${en}`,1200));
    if(!js||!js.criteria) throw 'K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá.';
    $('#tabWriting').click();
    showGradingResult(en,js,$('#wrHead'),$('#wrDiff'),$('#wrBreakdown'),'IELTS Overall (D·ªãch)',mode);
    $('#wrResult').style.display='grid';
    $('#trTaskHint').textContent='';
  }catch(e){$('#trTaskHint').textContent='L·ªói: '+e;}finally{setBusy(false);}
};

/* ====== CHAT AI (g√µ t·ª´ng ch·ªØ) ====== */
function appendMsg(text, mine=false, typing=false){
  const row=el('div','msg'+(mine?' me':'')); const b=el('div','bubble'); b.innerHTML=typing?('<span class="type">&nbsp;</span>'):esc(text); row.appendChild(b); $('#chatBox').appendChild(row); $('#chatBox').scrollTop=$('#chatBox').scrollHeight; return b;
}
async function typeOut(elm, text, speed=12){
  elm.innerHTML=''; let i=0; return new Promise(res=>{const id=setInterval(()=>{elm.textContent+=text[i++]||''; $('#chatBox').scrollTop=$('#chatBox').scrollHeight; if(i>=text.length){clearInterval(id); res();}}, speed);});
}
$('#btnAsk').onclick=async()=>{
  const q=($('#askInput').value||'').trim(); if(!q){$('#askHint').textContent='Nh·∫≠p c√¢u h·ªèi.';return;}
  $('#askHint').textContent=''; appendMsg(q,true);
  const bubble=appendMsg('',false,true);
  try{
    const sys=`B·∫°n l√† tr·ª£ l√Ω ti·∫øng Anh h·ªØu √≠ch. Gi·∫£i th√≠ch ng·∫Øn g·ªçn, c√≥ v√≠ d·ª•; n·∫øu ng∆∞·ªùi d√πng ƒë∆∞a c√¢u, h√£y s·ª≠a v√† n√™u l√Ω do. D√πng ti·∫øng Vi·ªát khi gi·∫£i th√≠ch, v√≠ d·ª• b·∫±ng EN.`;
    const ans=await callOpenAI(sys,q,650);
    await typeOut(bubble,ans.replace(/^```[\s\S]*?```/g,''),10);
  }catch(e){bubble.textContent='L·ªói: '+e;}
};

/* ====== DICTIONARY (nhi·ªÅu nghƒ©a) ====== */
function renderHistDict(){const hist=store.dict.slice(-14).reverse(); $('#dictHistory').innerHTML= hist.length?hist.map(w=>`<span class="errtag">${esc(w)}</span>`).join(''):'Ch∆∞a c√≥.';}
renderHistDict();
async function dictAPI(q){
  const sys=`B·∫°n l√† t·ª´ ƒëi·ªÉn EN‚áÑVI chu·∫©n. Tr·∫£ JSON:
{"headword":"","ipa_uk":"","ipa_us":"","pos":[""],"senses":[
 {"label":"nghƒ©a ch√≠nh","gloss_en":"","gloss_vi":"","examples":[{"en":"","vi":""}]},
 {"label":"nghƒ©a kh√°c/ng·ªØ c·∫£nh","gloss_en":"","gloss_vi":"","examples":[{"en":"","vi":""}]}
], "phrases":[{"phrasal":"","gloss_vi":"","example_en":"","example_vi":""}]}
G·ª£i √Ω 3‚Äì6 nghƒ©a n·∫øu c√≥; v√≠ d·ª• t·ª± nhi√™n.`;
  const out=await callOpenAI(sys,'Lookup: '+q,900);
  return parseJSON(out);
}
function showDict(d){
  const box=$('#dictOut'); box.innerHTML='';
  if(!d){box.innerHTML='<div class="mono">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>';return;}
  box.append(el('div','',`<h2 class="sectionTitle" style="margin:0">${esc(d.headword)} <span class="subtle">(${(d.pos||[]).join(', ')})</span></h2>`));
  box.append(el('div','subtle',`IPA UK: /${esc(d.ipa_uk||'-')}/ ‚Ä¢ IPA US: /${esc(d.ipa_us||'-')}/`));
  (d.senses||[]).forEach((s,i)=> box.append(el('div','card row',`<b>${i+1}. ${esc(s.label||s.gloss_en||'')}</b><div>${esc(s.gloss_en||'')}</div><div class="subtle">${esc(s.gloss_vi||'')}</div>${(s.examples||[]).map(e=>`<div class="mono">‚Ä¢ ${esc(e.en)} ‚Äî <span class="subtle">${esc(e.vi||'')}</span></div>`).join('')}`)));
  if(Array.isArray(d.phrases)&&d.phrases.length){ box.append(el('div','card row',`<b>Phrasal/Collocation</b>${d.phrases.map(p=>`<div class="mono">‚Ä¢ <b>${esc(p.phrasal)}</b> ‚Äî ${esc(p.gloss_vi)}<br><span class="subtle">${esc(p.example_en)}</span> ‚Äî ${esc(p.example_vi||'')}</div>`).join('')}`));}
}

/* ====== HISTORY / PROFILE ====== */
function addHistory({type,input,score,band,ok}){const at=store.attempts; at.push({at:Date.now(),type,input,score,band,ok}); store.attempts=at; }
function renderHistory(){const at=store.attempts, t=at.length, avg=t?Math.round(at.reduce((s,a)=>s+(a.score||0),0)/t):0, cor=at.filter(a=>a.type==='simple'&&a.ok).length, rate=t?Math.round(100*cor/t):0; $('#hisTotal').textContent=t; $('#hisAvg').textContent=avg; $('#hisCorrect').textContent=cor; $('#hisRate').textContent=rate+'%'; const tb=$('#hisTable tbody'); tb.innerHTML=at.slice().reverse().map(a=>`<tr><td>${new Date(a.at).toLocaleString()}</td><td>${esc(a.type)}</td><td class="mono">${esc(a.input||'')}</td><td>${a.band?('Band '+a.band.toFixed(1)):Math.round(a.score||0)}</td><td>${a.ok?'‚úÖ':'‚Äî'}</td></tr>`).join('');}
const drawer=$('#drawer'), bd=$('#backdrop'), av=$('#avatar'), nameI=$('#displayName');
function renderDonate(){ $('#dnName').textContent=DONATE_NAME; $('#dnNote').textContent=DONATE_NOTE; $('#dnQR').src=DONATE_QR_IMG; $('#dnPay').href=DONATE_PAY_URL; $('#dnCopy').onclick=async()=>{ try{await navigator.clipboard.writeText(DONATE_PAY_URL); $('#dnCopy').textContent='ƒê√£ copy ‚úì'; setTimeout(()=>$('#dnCopy').textContent='Copy link',1000);}catch(_){alert(DONATE_PAY_URL);} }; }
function openDrawer(){drawer.classList.add('show');bd.classList.add('show');fillProfile();renderDonate();}
function closeDrawer(){drawer.classList.remove('show');bd.classList.remove('show');}
$('#btnHamburger').onclick=openDrawer; $('#btnCloseDrawer').onclick=closeDrawer; bd.onclick=closeDrawer;
function fillProfile(){const at=store.attempts, t=at.length, avg=t?Math.round(at.reduce((s,a)=>s+(a.score||0),0)/t):0, cor=at.filter(a=>a.type==='simple'&&a.ok).length, rate=t?Math.round(100*cor/t):0; $('#pAvg').textContent=avg; $('#pTotal').textContent=t; $('#pRate').textContent=rate+'%'; av.src=store.avatar||'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"><rect width="100%" height="100%" fill="%23e8ecf3"/><text x="50%" y="54%" font-size="36" text-anchor="middle" fill="%23555">üôÇ</text></svg>'; nameI.value=store.name||'';}
av.onclick=()=>$('#filePicker').click();
$('#filePicker').onchange=(e)=>{const f=e.target.files?.[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{store.avatar=r.result; av.src=r.result;}; r.readAsDataURL(f);};
nameI.oninput=()=>{store.name=nameI.value.trim();};
$('#btnExportCSV').onclick=()=>{const at=store.attempts; if(!at.length){alert('Ch∆∞a c√≥ d·ªØ li·ªáu.');return;} let csv='time,type,input,score,band,ok\n'; at.forEach(a=>{const q=(a.input||'').replace(/"/g,'""'); csv+=`${new Date(a.at).toISOString()},"${(a.type||'').replace(/"/g,'""')}","${q}",${a.score??''},${a.band??''},${a.ok||false}\n`;}); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='history.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);};
$('#btnResetProfile').onclick=()=>{ if(confirm('Xo√° to√†n b·ªô l·ªãch s·ª≠?')){ store.attempts=[]; fillProfile(); renderHistory(); } };

/* ====== SETTINGS ====== */
$('#apiKey').value=store.key; $('#model').value=store.mdl; $('#endpoint').value=store.ep;
$('#btnSave').onclick=()=>{store.key=$('#apiKey').value.trim(); store.mdl=$('#model').value; store.ep=$('#endpoint').value.trim(); $('#saveMsg').textContent='ƒê√£ l∆∞u.'; setTimeout(()=>$('#saveMsg').textContent='',1000);};

/* ====== INIT ====== */
function init(){renderPractice(); fillProfile(); applyFooterPadding();}
init();
</script><script>
/* ====== ADMIN ANNOUNCEMENT (1-DAY DISMISS) ====== */
/* C√¥ng t·∫Øc t·ªïng: 'T' = b·∫≠t, 'F' = t·∫Øt to√†n b·ªô th√¥ng b√°o */
const ANNOUNCE_SWITCH = 'T';

/* ƒê·ªïi ANNOUNCE_ID m·ªói khi b·∫°n c√≥ th√¥ng b√°o m·ªõi ƒë·ªÉ √©p m·ªçi ng∆∞·ªùi th·∫•y l·∫°i */
const ANNOUNCE_ID = '2025-09-07-v2';

/* N·ªôi dung th√¥ng b√°o (cho ph√©p HTML ƒë∆°n gi·∫£n) */
const ANNOUNCE_TITLE = 'C·∫≠p nh·∫≠t h·ªá th·ªëng';
const ANNOUNCE_HTML = `
<ul style="margin:0 0 6px 18px">
  <li>S·ª≠a highlight: b√†i ƒë√∫ng band 7‚Äì9 s·∫Ω t√¥ <b>xanh</b>, g·∫ßn ƒë√∫ng v√†ng (5‚Äì6), sai ƒë·ªè.</li>
  <li>Ch·∫•m 10‚Äì100 cho b√†i d√†i: chia ƒëo·∫°n, kh√¥ng ‚Äúb√£o l·ªói‚Äù.</li>
  <li>Gen IELTS: Task1/Task2 (VI) t√°ch ri√™ng v·ªõi ‚ÄúVƒÉn n√≥i‚Äù.</li>
</ul>
<div class="subtle">N·∫øu b·∫°n th·∫•y l·ªói, vui l√≤ng F5 ho·∫∑c xo√° cache.</div>
`;

/* Key l∆∞u localStorage */
const ANNOUNCE_LS = 'announce_state_v2';

function _readState() {
  try { return JSON.parse(localStorage.getItem(ANNOUNCE_LS) || '{}'); } catch(_) { return {}; }
}
function _writeState(s) {
  localStorage.setItem(ANNOUNCE_LS, JSON.stringify(s || {}));
}
function _shouldShow() {
  if (ANNOUNCE_SWITCH !== 'T') return false; // t·∫Øt to√†n b·ªô
  const now = Date.now();
  const st = _readState();
  // N·∫øu ID thay ƒë·ªïi -> hi·ªán l·∫°i (b·ªè qua until c≈©)
  if (st.id !== ANNOUNCE_ID) return true;
  // N·∫øu ch∆∞a h·∫øt h·∫°n ‚Äú·∫©n 1 ng√†y‚Äù -> kh√¥ng hi·ªán
  if (typeof st.until === 'number' && now < st.until) return false;
  return true;
}
function _dismissOneDay() {
  const until = Date.now() + 24*60*60*1000; // 24h
  _writeState({ id: ANNOUNCE_ID, until });
}
function _justClose() {
  // Kh√¥ng ghi until ‚Üí l·∫ßn sau v·∫´n hi·ªán (tr·ª´ khi SWITCH=F)
  _writeState({ id: ANNOUNCE_ID });
}

function _injectAnnounceStyles() {
  if (document.getElementById('announceStyles')) return;
  const css = `
  .announce-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:9998}
  .announce-modal{position:fixed;inset:auto 0 0 0; margin:auto; top:12vh; width:min(560px,92vw); z-index:9999;
    background:var(--panel,#fff); color:var(--ink,#0f1a2b); border:1px solid var(--line,#e9ecf3);
    border-radius:14px; box-shadow:0 18px 60px rgba(16,24,40,.2),0 4px 14px rgba(16,24,40,.12); overflow:hidden}
  .announce-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:14px 16px;
    background:linear-gradient(180deg,var(--brand,#3a63ff),var(--brand2,#6f8bff)); color:#fff; font-weight:800}
  .announce-body{padding:14px 16px; font-size:14px; line-height:1.6}
  .announce-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--line,#e9ecf3)}
  .bt{appearance:none;cursor:pointer;border-radius:10px;border:1px solid var(--line,#dfe5f0);padding:9px 12px;font-weight:700}
  .bt.primary{background:#fff;color:#0f1a2b}
  .bt.brand{background:linear-gradient(180deg,var(--brand,#3a63ff),var(--brand2,#6f8bff));color:#fff;border-color:transparent}
  .x{background:transparent;border:none;color:#fff;font-size:18px;line-height:1;cursor:pointer;padding:0 4px}
  `;
  const style = document.createElement('style');
  style.id = 'announceStyles';
  style.textContent = css;
  document.head.appendChild(style);
}

function showAnnouncement() {
  _injectAnnounceStyles();

  const bd = document.createElement('div');
  bd.className = 'announce-backdrop'; bd.id = 'announceBackdrop';

  const md = document.createElement('div');
  md.className = 'announce-modal'; md.id = 'announceModal';

  md.innerHTML = `
    <div class="announce-head">
      <div>${ANNOUNCE_TITLE}</div>
      <button class="x" aria-label="ƒê√≥ng" title="ƒê√≥ng">‚úï</button>
    </div>
    <div class="announce-body">${ANNOUNCE_HTML}</div>
    <div class="announce-actions">
      <button class="bt primary" id="annClose">ƒê√≥ng</button>
      <button class="bt brand" id="annHideDay">Kh√¥ng hi·ªán l·∫°i trong 1 ng√†y</button>
    </div>
  `;

  document.body.appendChild(bd);
  document.body.appendChild(md);

  const closeAll = (persist=false) => {
    if (persist) _dismissOneDay(); else _justClose();
    md.remove(); bd.remove();
  };

  md.querySelector('.x').onclick = ()=>closeAll(false);
  md.querySelector('#annClose').onclick = ()=>closeAll(false);
  md.querySelector('#annHideDay').onclick = ()=>closeAll(true);
  bd.onclick = ()=>closeAll(false); // click ra ngo√†i = ƒë√≥ng (kh√¥ng set 1 ng√†y)
}

// Kh·ªüi ch·∫°y
try {
  if (_shouldShow()) showAnnouncement();
} catch(e) {
  console.error('announce err:', e);
}
</script>
</body>
</html>
